{% comment %}
  Product Glass Panel + Left Carousel

  ALWAYS use the per-product fallback product (Product reference metafield):
  product.metafields.custom.pgc_fallback_product

  Background via metafield on the ACTIVE product_obj:
  product_obj.metafields.custom.pgc_background

  Middle word via metafield on the ACTIVE product_obj:
  product_obj.metafields.custom.pgc_middle_text

  Glass color via metafield on the ACTIVE product_obj (type: Color):
  product_obj.metafields.custom.pgc_glass_color
{% endcomment %}

{% assign section_id = section.id | replace: '_', '' | downcase %}

{% assign context_product = product %}

{% assign per_product_fallback = blank %}
{% if context_product and context_product.metafields.custom.pgc_fallback_product and context_product.metafields.custom.pgc_fallback_product.value != blank %}
  {% assign per_product_fallback = context_product.metafields.custom.pgc_fallback_product.value %}
{% endif %}

{% assign product_obj = per_product_fallback | default: context_product %}

{% assign bg = blank %}
{% if product_obj and product_obj.metafields.custom.pgc_background and product_obj.metafields.custom.pgc_background.value != blank %}
  {% assign bg = product_obj.metafields.custom.pgc_background.value %}
{% endif %}

{% assign mid_text = blank %}
{% if product_obj and product_obj.metafields.custom.pgc_middle_text and product_obj.metafields.custom.pgc_middle_text.value != blank %}
  {% assign mid_text = product_obj.metafields.custom.pgc_middle_text.value %}
{% endif %}
{% if mid_text == blank %}
  {% assign mid_text = section.settings.middle_text %}
{% endif %}
{% if mid_text == blank and product_obj %}
  {% assign mid_text = product_obj.title %}
{% endif %}

{% assign glass_color = '#ffffff' %}
{% if product_obj and product_obj.metafields.custom.pgc_glass_color and product_obj.metafields.custom.pgc_glass_color.value != blank %}
  {% assign glass_color = product_obj.metafields.custom.pgc_glass_color.value %}
{% endif %}

{% style %}
  .pgc-{{ section_id }}{
    position:relative;
    width:100%;
    overflow:hidden;
    min-height: {{ section.settings.min_height }}px;
  }

  .pgc-{{ section_id }}__bg{ position:absolute; inset:0; z-index:0; }
  .pgc-{{ section_id }}__bg img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pgc-{{ section_id }}__bgPlaceholder{ width:100%; height:100%; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }

  .pgc-{{ section_id }}__container{ position:relative; z-index:1; max-width:100%; margin:0; padding:0; }

  .pgc-{{ section_id }}__grid{
    display:grid;
    grid-template-columns: 1fr {{ section.settings.middle_width }}px 1fr;
    align-items:stretch;
    min-height: {{ section.settings.min_height }}px;
    position:relative;
  }

  .pgc-{{ section_id }}__left{
    padding: {{ section.settings.section_padding }}px {{ section.settings.side_padding }}px;
    width:100%;
    display:flex;
    justify-content:flex-end;
    align-items:center;
    position:relative;
    z-index:2;
  }

  .pgc-{{ section_id }}__leftInner{
    width:100%;
    max-width: {{ section.settings.container_width }}px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }

  .pgc-{{ section_id }}__middle{
    position:relative;
    pointer-events:none;
    z-index:3;
  }

  .pgc-{{ section_id }}__word{
    position:absolute;
    top:50%;
    left: calc(50% + {{ section.settings.middle_text_shift }}px);
    transform: translate(-50%,-50%) rotate(180deg);
    writing-mode: vertical-rl;
    font-size: {{ section.settings.middle_text_size }}px;
    font-weight: 900;
    letter-spacing: {{ section.settings.middle_letter_spacing }}px;
    line-height: .9;
    white-space: nowrap;
    color: {{ section.settings.middle_text_color }};
  }

  .pgc-{{ section_id }}__word--left{
    z-index:5;
    opacity: {{ section.settings.middle_text_opacity | divided_by: 100.0 }};
    filter: blur({{ section.settings.middle_text_blur }}px);
    clip-path: inset(0 {{ section.settings.word_right_cut }}% 0 0);
  }

  .pgc-{{ section_id }}__word--right{
    z-index:1;
    opacity: {{ section.settings.word_inside_opacity | divided_by: 100.0 }};
    filter: blur({{ section.settings.word_inside_blur }}px);
    clip-path: inset(0 0 0 {{ section.settings.word_left_cut }}%);
  }

  .pgc-{{ section_id }}__carousel{
    position:relative;
    overflow:hidden;
    border-radius: {{ section.settings.image_border_radius }}px;
    aspect-ratio: 1;
    background: rgba(255,255,255,.06);
  }
  .pgc-{{ section_id }}__track{
    display:flex;
    height:100%;
    will-change: transform;
    transition: transform .4s ease;
  }
  .pgc-{{ section_id }}__slide{ min-width:100%; height:100%; }
  .pgc-{{ section_id }}__slide img,
  .pgc-{{ section_id }}__slide video,
  .pgc-{{ section_id }}__slide iframe,
  .pgc-{{ section_id }}__slide model-viewer{
    width:100%; height:100%;
    object-fit:cover; display:block;
  }

  /* arrows: NO circle */
  .pgc-{{ section_id }}__navBtn{
    position:absolute; top:50%;
    transform: translateY(-50%);
    width:auto; height:auto;
    padding:0;
    border:0; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    z-index:2;
    background: transparent;
    box-shadow:none;
    border-radius:0;
  }
  .pgc-{{ section_id }}__navPrev{ left:  14px; }
  .pgc-{{ section_id }}__navNext{ right: 14px; }

  .pgc-{{ section_id }}__navBtn svg{ width:30px; height:30px; }
  .pgc-{{ section_id }}__navBtn svg{ color:ED1B1B; }
  .pgc-{{ section_id }}__navBtn svg path{ stroke:currentColor; }


  .pgc-{{ section_id }}__navBtn:hover{ opacity:.85; }

  /* remove dots + thumbs */
  .pgc-{{ section_id }}__dots{ display:none !important; }
  .pgc-{{ section_id }}__thumbs{ display:none !important; }

  .pgc-{{ section_id }}__panel{
    position:relative;
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    z-index:4;
  }

  .pgc-{{ section_id }}__card{
    width:100%;
    height:100%;
    background: rgba(
      {{ glass_color | color_extract: 'red' }},
      {{ glass_color | color_extract: 'green' }},
      {{ glass_color | color_extract: 'blue' }},
      {{ section.settings.glass_opacity | divided_by: 100.0 }}
    );
    backdrop-filter: blur({{ section.settings.glass_blur }}px) saturate(180%) contrast(120%);
    -webkit-backdrop-filter: blur({{ section.settings.glass_blur }}px) saturate(180%) contrast(120%);
    border-left: {{ section.settings.glass_border_width }}px solid rgba(255,255,255,{{ section.settings.glass_border_opacity | divided_by: 100.0 }});
    border-top:0; border-right:0; border-bottom:0;
    box-shadow:
      -30px 0 85px rgba(0,0,0,.25),
      inset 1px 0 0 rgba(255,255,255,.22),
      inset 0 1px 0 rgba(255,255,255,.10);
    border-radius: {{ section.settings.glass_border_radius }}px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }

  .pgc-{{ section_id }}__card .pgc-{{ section_id }}__word--right{
    position:absolute;
    top:50%;
    left: calc(-1 * ({{ section.settings.middle_width }}px / 2) + {{ section.settings.inside_text_shift }}px);
    transform: translate(-50%,-50%) rotate(180deg);
    writing-mode: vertical-rl;
    pointer-events:none;
  }

  .pgc-{{ section_id }}__cardInner{
    padding: 56px;
    max-width: 560px;
    width:100%;
    position:relative;
    z-index:2;
  }

  .pgc-{{ section_id }}__title{
    margin:0 0 18px;
    color: {{ section.settings.text_color }};
    font-size: {{ section.settings.title_size }}px;
    font-weight: 800;
    line-height:1.15;
  }

  .pgc-{{ section_id }}__price{
    margin:0 0 28px;
    color: {{ section.settings.text_color }};
    font-size: {{ section.settings.price_size }}px;
    font-weight: 750;
  }

  .pgc-{{ section_id }}__label{
    display:block;
    margin: 22px 0 10px;
    color: {{ section.settings.text_color }};
    font-weight: 700;
    font-size: 14px;
  }

  .pgc-{{ section_id }}__select{
    width:100%;
    padding:12px 14px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.28);
    background: rgba(255,255,255,.10);
    color: {{ section.settings.text_color }};
    margin-bottom: 18px;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
  }

  .pgc-{{ section_id }}__qtyRow{ display:flex; align-items:center; gap:16px; margin: 0 0 2rem 0; }

  .pgc-{{ section_id }}__qtyBtn{
    width:50px; height:50px;
    border-radius: 4px;
    border:1px solid rgba(255,255,255,.3);
    background: rgba(255,255,255,.1);
    color: {{ section.settings.text_color }};
    font-size:24px;
    cursor:pointer;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    font-weight: 500;
  }

  .pgc-{{ section_id }}__qtyInput{
    width:90px; height:50px;
    text-align:center;
    border-radius: 4px;
    border:1px solid rgba(255,255,255,.3);
    background: rgba(255,255,255,.1);
    color: {{ section.settings.text_color }};
    font-size:1.2rem;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    font-weight: 500;
  }

  .pgc-{{ section_id }}__cta{
    width:100%;
    margin: 10px 0 26px;
    padding:20px 24px;
    border:0;
    border-radius: {{ section.settings.button_border_radius }}px;
    cursor:pointer;
    background: {{ section.settings.button_bg_color }};
    color: {{ section.settings.button_text_color }};
    font-weight: 700;
    font-size: 1.1rem;
    letter-spacing: 0.1em;
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .pgc-{{ section_id }}__cta:hover{
    background: {{ section.settings.button_hover_bg_color }};
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(0,0,0,.22);
  }

  .pgc-{{ section_id }}__desc{
    margin:0;
    padding-top: 18px;
    border-top: 1px solid rgba(255,255,255,.15);
    color: {{ section.settings.text_color }};
    font-size: 14px;
    line-height:1.6;
    opacity: .95;
  }

  /* Minimalist PDP Styles */
  .pgc-minimal-pdp {
    color: {{ section.settings.text_color }};
  }

  .pgc-minimal__header {
    padding-top: 0;
    margin-bottom: 1.5rem;
  }

  .pgc-minimal__title {
    margin: 0 0 2rem 0;
    font-size: 2.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    line-height: 1.2;
    color: {{ section.settings.text_color }};
  }

  .pgc-minimal__fitrow {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 3rem;
    border-top: 1px solid rgba(255,255,255,0.12);
    padding-top: 2rem;
    margin-bottom: 2.5rem;
  }

  .pgc-minimal__left {
    min-width: 220px;
  }

  .pgc-minimal__kicker {
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.9;
    color: {{ section.settings.text_color }};
    margin-bottom: 0.75rem;
    font-weight: 500;
  }

  .pgc-minimal__size {
    margin-top: 0.75rem;
    font-size: 1.4rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: {{ section.settings.text_color }};
    font-weight: 600;
  }

  .pgc-minimal__price {
    margin-top: 0.75rem;
    color: {{ section.settings.text_color }};
  }

  .pgc-minimal__price .price {
    font-size: 1.5rem;
  }

  .pgc-minimal__price .price-item {
    font-size: 1.5rem;
    font-weight: 500;
  }

  .pgc-minimal__price .price-item--regular {
    font-size: 1.5rem;
  }

  .pgc-fitscale {
    width: 100%;
    max-width: 400px;
  }

  .pgc-fitscale__labels {
    display: flex;
    justify-content: space-between;
    gap: 1.5rem;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.9;
    color: {{ section.settings.text_color }};
    font-weight: 500;
  }

  .pgc-fitscale__bar {
    position: relative;
    height: 2px;
    margin-top: 0.6rem;
    background: rgba(255,255,255,0.35);
  }

  .pgc-fitscale__marker {
    position: absolute;
    top: 50%;
    left: var(--fit-pos, 50%);
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    border-radius: 999px;
    border: 2px solid {{ section.settings.text_color }};
    background: rgba(255,255,255,0.1);
  }

  .pgc-minimal__accordion {
    margin-top: 0;
  }

  .pgc-minimal__accordion details {
    border-bottom: 1px solid rgba(255,255,255,0.12);
  }

  .pgc-minimal__accordion summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1.05rem 0;
    cursor: pointer;
    list-style: none;
  }

  .pgc-minimal__accordion summary::-webkit-details-marker {
    display: none;
  }

  .pgc-minimal__accordion .summary__title {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .pgc-minimal__accordion .accordion__title {
    margin: 0;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: {{ section.settings.text_color }};
    font-weight: 500;
  }

  .pgc-minimal__variant-label {
    display: block;
    margin: 2rem 0 1rem 0;
    color: {{ section.settings.text_color }};
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 500;
  }

  .pgc-minimal__variant-select {
    width: 100%;
    padding: 18px 20px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: {{ section.settings.text_color }};
    font-size: 1.2rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
    padding-right: 50px;
    font-weight: 500;
  }

  .pgc-minimal__quantity-label {
    display: block;
    margin: 2rem 0 1rem 0;
    color: {{ section.settings.text_color }};
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 500;
  }

  .pgc-accordion-icon {
    font-size: 1.25rem;
    line-height: 1;
    color: {{ section.settings.text_color }};
  }

  .pgc-accordion-icon::before {
    content: "+";
  }

  .pgc-minimal__accordion details[open] .pgc-accordion-icon::before {
    content: "–";
  }

  .pgc-minimal__accordion .accordion__content {
    padding: 0 0 1.15rem 0;
    color: {{ section.settings.text_color }};
    opacity: 0.9;
  }

  /* Size buttons styling */
  .pgc-minimal__size-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 2rem;
  }

  .pgc-minimal__size-btn {
    padding: 12px 20px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: {{ section.settings.text_color }};
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    border-radius: 4px;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
    position: relative;
    pointer-events: auto;
    z-index: 1;
    user-select: none;
    -webkit-user-select: none;
  }
  
  .pgc-minimal__size-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .pgc-minimal__size-btn:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.4);
    transform: translateY(-1px);
  }

  .pgc-minimal__size-btn--selected {
    background: rgba(255,255,255,0.35) !important;
    border-color: rgba(255,255,255,0.8) !important;
    border-width: 2px !important;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(255,255,255,0.2);
    transform: translateY(-2px);
  }

  .pgc-minimal__size-btn--selected::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 4px;
    padding: 2px;
    background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
  }

  .pgc-minimal__variant-select--hidden {
    display: none;
  }

  @media (max-width: 900px){
    .pgc-{{ section_id }}{ min-height: auto; }
    .pgc-{{ section_id }}__grid{ grid-template-columns: 1fr; min-height:auto; }
    .pgc-{{ section_id }}__middle{ display:none; }
    .pgc-{{ section_id }}__word--left{ display:none; }
    .pgc-{{ section_id }}__left{ justify-content:center; padding: {{ section.settings.section_padding }}px {{ section.settings.side_padding }}px; }
    .pgc-{{ section_id }}__card{
      border-left:0;
      border-top: {{ section.settings.glass_border_width }}px solid rgba(255,255,255,{{ section.settings.glass_border_opacity | divided_by: 100.0 }});
    }
    .pgc-{{ section_id }}__cardInner{ padding: 34px 22px; max-width: 640px; }

    /* Mobile: Reorder to show FIT first */
    .pgc-minimal-pdp {
      display: flex;
      flex-direction: column;
    }

    .pgc-minimal__header {
      order: 1;
    }

    .pgc-minimal__fitrow {
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .pgc-minimal__left {
      min-width: 0;
    }

    .pgc-fitscale {
      max-width: none;
      width: 100%;
    }

    /* Hide color options on mobile */
    .pgc-variant-option--color {
      display: none !important;
    }

    /* Show size buttons on mobile */
    .pgc-minimal__size-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .pgc-minimal__size-btn {
      flex: 1;
      min-width: 60px;
      padding: 14px 16px;
      font-size: 0.95rem;
    }

    /* Form comes after FIT */
    form {
      order: 2;
    }

    /* Accordions come last */
    .pgc-minimal__accordion {
      order: 3;
    }
  }
{% endstyle %}

{% if product_obj %}
<section class="pgc-{{ section_id }}">
  <div class="pgc-{{ section_id }}__bg" aria-hidden="true">
    {% if bg %}
      <img src="{{ bg | image_url: width: 2400 }}" alt="" loading="lazy">
    {% else %}
      <div class="pgc-{{ section_id }}__bgPlaceholder"></div>
    {% endif %}
  </div>

  <div class="pgc-{{ section_id }}__container">
    <div class="pgc-{{ section_id }}__grid">

      <div class="pgc-{{ section_id }}__left">
        <div class="pgc-{{ section_id }}__leftInner">

          <div class="pgc-{{ section_id }}__carousel" data-carousel>
            <div class="pgc-{{ section_id }}__track" data-track>
              {% assign media_list = product_obj.media %}
              {% if media_list and media_list.size > 0 %}
                {% for m in media_list %}
                  <div class="pgc-{{ section_id }}__slide" data-slide>
                    {% case m.media_type %}
                      {% when 'image' %}
                        <img src="{{ m | image_url: width: 1600 }}" alt="{{ m.alt | escape }}" loading="lazy">
                      {% when 'video' %}
                        {{ m | video_tag: controls: true, playsinline: true, preload: 'metadata' }}
                      {% when 'external_video' %}
                        {{ m | external_video_tag }}
                      {% when 'model' %}
                        {{ m | model_viewer_tag }}
                      {% else %}
                        {{ 'product-1' | placeholder_svg_tag }}
                    {% endcase %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="pgc-{{ section_id }}__slide" data-slide>
                  {% if product_obj.featured_image %}
                    <img
                      src="{{ product_obj.featured_image | image_url: width: 1600 }}"
                      alt="{{ product_obj.title | escape }}"
                      loading="lazy"
                      width="{{ product_obj.featured_image.width }}"
                      height="{{ product_obj.featured_image.height }}"
                    >
                  {% else %}
                    {{ 'product-1' | placeholder_svg_tag }}
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <button type="button" class="pgc-{{ section_id }}__navBtn pgc-{{ section_id }}__navPrev" aria-label="Previous" data-prev>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button type="button" class="pgc-{{ section_id }}__navBtn pgc-{{ section_id }}__navNext" aria-label="Next" data-next>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
          </div>

          <div class="pgc-{{ section_id }}__dots" data-dots></div>
          <div class="pgc-{{ section_id }}__thumbs" data-thumbs></div>

        </div>
      </div>

      <div class="pgc-{{ section_id }}__middle" aria-hidden="true">
        <div class="pgc-{{ section_id }}__word pgc-{{ section_id }}__word--left">
          {{ mid_text }}
        </div>
      </div>

      <div class="pgc-{{ section_id }}__panel">
        <div class="pgc-{{ section_id }}__card">
          <div class="pgc-{{ section_id }}__word pgc-{{ section_id }}__word--right" aria-hidden="true">
            {{ mid_text }}
          </div>

          <div class="pgc-{{ section_id }}__cardInner pgc-minimal-pdp">
            {%- liquid
              assign composed_title = product_obj.title | escape
              
              # Optionally append color to title
              if section.settings.append_color_option
                assign color_value = ''
                for opt in product_obj.options_with_values
                  assign opt_name_down = opt.name | downcase
                  if opt_name_down == 'color' or opt_name_down == 'colour'
                    assign color_value = opt.selected_value
                  endif
                endfor
                if color_value != blank
                  assign composed_title = composed_title | append: ' - ' | append: color_value | escape
                endif
              endif

              # Get selected size
              assign selected_size = ''
              for opt in product_obj.options_with_values
                assign opt_name_down = opt.name | downcase
                if opt_name_down contains 'size'
                  assign selected_size = opt.selected_value
                endif
              endfor
              if selected_size == blank
                assign selected_size = product_obj.selected_or_first_available_variant.title
              endif
              if selected_size == 'Default Title'
                assign selected_size = ''
              endif
            -%}

            <div class="pgc-minimal__header">
              <h1 class="pgc-minimal__title">{{ composed_title }}</h1>

              <div class="pgc-minimal__fitrow">
                <div class="pgc-minimal__left">
                  <div class="pgc-minimal__kicker">{{ section.settings.fit_label | default: 'FIT' }}</div>
                  {%- if section.settings.show_selected_size and selected_size != blank -%}
                    <div class="pgc-minimal__size" data-pgc-size>{{ selected_size }}</div>
                  {%- endif -%}

                  <div class="pgc-minimal__price" id="pgc-price-{{ section_id }}">
                    {%- render 'price',
                      product: product_obj,
                      use_variant: true,
                      show_badges: false,
                      price_class: 'price--large'
                    -%}
                  </div>
                </div>

                <div class="pgc-minimal__right">
                  <div class="pgc-fitscale" style="--fit-pos: {{ section.settings.fit_position }}%;">
                    <div class="pgc-fitscale__labels">
                      <span>{{ section.settings.fit_small_label | default: 'SMALL' }}</span>
                      <span>{{ section.settings.fit_true_label | default: 'TRUE TO SIZE' }}</span>
                      <span>{{ section.settings.fit_large_label | default: 'LARGE' }}</span>
                    </div>
                    <div class="pgc-fitscale__bar" aria-hidden="true">
                      <span class="pgc-fitscale__marker" aria-hidden="true"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {%- assign product_form_id = 'product-form-pgc-' | append: section_id -%}
            {% form 'product', product_obj, id: product_form_id %}
              {% unless product_obj.has_only_default_variant %}
                {% for option in product_obj.options_with_values %}
                  {%- assign opt_name_down = option.name | downcase -%}
                  {%- assign is_color = false -%}
                  {%- if opt_name_down == 'color' or opt_name_down == 'colour' -%}
                    {%- assign is_color = true -%}
                  {%- endif -%}
                  
                  <div class="pgc-variant-option {% if is_color %}pgc-variant-option--color{% endif %}">
                    <label class="pgc-minimal__variant-label" for="Option-{{ section_id }}-{{ forloop.index0 }}">
                      {{ option.name }}
                    </label>
                    
                    {%- if opt_name_down contains 'size' -%}
                      <div class="pgc-minimal__size-buttons">
                        {% for value in option.values %}
                          <button 
                            type="button"
                            class="pgc-minimal__size-btn {% if option.selected_value == value %}pgc-minimal__size-btn--selected{% endif %}"
                            data-value="{{ value | escape }}"
                            data-option-name="{{ option.name | escape }}"
                            data-option-position="{{ forloop.index0 }}"
                          >
                            {{ value }}
                          </button>
                        {% endfor %}
                        <select 
                          class="pgc-minimal__variant-select pgc-minimal__variant-select--hidden" 
                          id="Option-{{ section_id }}-{{ forloop.index0 }}"
                          name="options[{{ option.name | escape }}]"
                          data-option-position="{{ forloop.index0 }}"
                        >
                          {% for value in option.values %}
                            <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                              {{ value }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {%- else -%}
                      <select 
                        class="pgc-minimal__variant-select {% if is_color %}pgc-minimal__variant-select--color{% endif %}" 
                        id="Option-{{ section_id }}-{{ forloop.index0 }}"
                        name="options[{{ option.name | escape }}]"
                        data-option-position="{{ forloop.index0 }}"
                      >
                        {% for value in option.values %}
                          <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                            {{ value }}
                          </option>
                        {% endfor %}
                      </select>
                    {%- endif -%}
                  </div>
                {% endfor %}
              {% endunless %}

              <label class="pgc-minimal__quantity-label" for="Quantity-pgc-{{ section_id }}">Quantity</label>
              <div class="pgc-{{ section_id }}__qtyRow">
                <button type="button" class="pgc-{{ section_id }}__qtyBtn" data-qty="dec" aria-label="Decrease">−</button>
                <input 
                  class="pgc-{{ section_id }}__qtyInput" 
                  type="number" 
                  id="Quantity-pgc-{{ section_id }}"
                  name="quantity" 
                  value="1" 
                  min="1"
                >
                <button type="button" class="pgc-{{ section_id }}__qtyBtn" data-qty="inc" aria-label="Increase">+</button>
              </div>

              <input type="hidden" name="id" value="{{ product_obj.selected_or_first_available_variant.id }}" data-variant-id>
              
              <button class="pgc-{{ section_id }}__cta" type="submit" style="width: 100%; margin-top: 2rem; text-transform: uppercase;">
                {{ section.settings.button_text }}
              </button>
            {% endform %}

            {% if product_obj.description != blank %}
              <div class="pgc-minimal__accordion accordion" style="margin-top: 2rem;">
                <details id="Details-description-pgc-{{ section_id }}">
                  <summary>
                    <div class="summary__title">
                      <h2 class="h4 accordion__title">
                        {{ section.settings.description_heading | default: 'DESCRIPTION' | escape }}
                      </h2>
                    </div>
                    <span class="pgc-accordion-icon"></span>
                  </summary>
                  <div class="accordion__content rte" id="Accordion-description-pgc-{{ section_id }}">
                    {{ product_obj.description }}
                  </div>
                </details>
              </div>
            {% endif %}

            <div class="pgc-minimal__accordion accordion">
              <details id="Details-shipping-pgc-{{ section_id }}">
                <summary>
                  <div class="summary__title">
                    <h2 class="h4 accordion__title">
                      {{ section.settings.shipping_heading | default: 'SHIPPING AND RETURNS' | escape }}
                    </h2>
                  </div>
                  <span class="pgc-accordion-icon">+</span>
                </summary>
                <div class="accordion__content rte" id="Accordion-shipping-pgc-{{ section_id }}">
                  {%- if shop.shipping_policy.body != blank -%}
                    <div class="pgc-minimal__policy">
                      {{ shop.shipping_policy.body }}
                    </div>
                  {%- endif -%}
                  {%- if shop.refund_policy.body != blank -%}
                    <div class="pgc-minimal__policy">
                      {{ shop.refund_policy.body }}
                    </div>
                  {%- endif -%}
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endif %}

<script>
  (function(){
    const root = document.querySelector('.pgc-{{ section_id }}');
    if(!root) return;

    const track = root.querySelector('[data-track]');
    const slides = track ? Array.from(track.querySelectorAll('[data-slide]')) : [];
    const prev = root.querySelector('[data-prev]');
    const next = root.querySelector('[data-next]');
    const dots = root.querySelector('[data-dots]');
    const thumbs = root.querySelector('[data-thumbs]');

    let i = 0;

    function pauseAllMedia() {
      slides.forEach(s => {
        const v = s.querySelector('video');
        if (v && !v.paused) v.pause();
        const f = s.querySelector('iframe');
        if (f && f.src) { const src = f.src; f.src = src; }
      });
    }

    function setSlide(n){
      if(!track || slides.length <= 1) return;
      i = (n + slides.length) % slides.length;
      track.style.transform = `translateX(${-i * 100}%)`;
      pauseAllMedia();
    }

    function buildDots(){
      if(!track || slides.length <= 1){
        if(prev) prev.style.display = 'none';
        if(next) next.style.display = 'none';
        if(dots) dots.style.display = 'none';
        return;
      }
      if(prev) prev.addEventListener('click', ()=> setSlide(i - 1));
      if(next) next.addEventListener('click', ()=> setSlide(i + 1));
    }

    function buildThumbs(){
      if(thumbs) thumbs.style.display = 'none';
    }

    root.querySelectorAll('[data-qty]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const input = btn.closest('form')?.querySelector('input[name="quantity"]') || root.querySelector('input[name="quantity"]');
        const v = parseInt(input.value, 10) || 1;
        input.value = btn.dataset.qty === 'inc' ? v + 1 : Math.max(1, v - 1);
      });
    });

    buildDots();
    buildThumbs();
    setSlide(0);

    // Minimalist PDP: Update size and price on variant change
    const form = root.querySelector('#product-form-pgc-{{ section_id }}');
    const sizeEl = root.querySelector('[data-pgc-size]');
    const priceEl = root.querySelector('#pgc-price-{{ section_id }}');
    const variantIdInput = root.querySelector('[data-variant-id]');
    const productData = {% if product_obj %}{{ product_obj | json }}{% else %}null{% endif %};

    if (form && productData) {
      // Listen for variant changes from variant-selects component
      const variantSelects = root.querySelector('variant-selects');
      
      function updateSizeAndPrice(variant) {
        if (!variant) return;
        
        if (variantIdInput) variantIdInput.value = variant.id;
        
        // Update size
        if (sizeEl && variant.options) {
          const sizeOptionIndex = productData.options.findIndex(opt => 
            opt.name.toLowerCase().includes('size')
          );
          if (sizeOptionIndex !== -1 && variant.options[sizeOptionIndex]) {
            sizeEl.textContent = variant.options[sizeOptionIndex];
          } else if (variant.title !== 'Default Title') {
            sizeEl.textContent = variant.title;
          }
        }

        // Update price
        if (priceEl && variant.price) {
          const priceText = new Intl.NumberFormat('{{ localization.language.iso_code }}', {
            style: 'currency',
            currency: '{{ cart.currency.iso_code }}'
          }).format(variant.price / 100);
          
          const priceContainer = priceEl.querySelector('.price') || priceEl;
          if (priceContainer.querySelector('.price-item--regular')) {
            priceContainer.querySelector('.price-item--regular').textContent = priceText;
          } else {
            priceContainer.innerHTML = `<span class="price-item price-item--regular">${priceText}</span>`;
          }
        }
      }

      // Listen to variant-selects component events
      if (variantSelects) {
        variantSelects.addEventListener('change', (e) => {
          const variantId = e.detail?.variant?.id || variantIdInput?.value;
          if (variantId && productData.variants) {
            const variant = productData.variants.find(v => v.id.toString() === variantId.toString());
            updateSizeAndPrice(variant);
          }
        });
      }

      // Listen to direct option changes (dropdown selects)
      const optionSelects = form.querySelectorAll('select[name^="options"]');
      
      function updateVariant() {
        const selectedOptions = Array.from(optionSelects).map(select => select.value);

        const variant = productData.variants.find(v => {
          return v.options.every((opt, idx) => opt === selectedOptions[idx]);
        });

        updateSizeAndPrice(variant);
      }

      optionSelects.forEach(select => {
        select.addEventListener('change', updateVariant);
      });
      
      // Function to update selected button state for a specific option
      function updateSelectedSizeButtonForOption(optionPosition) {
        const select = form.querySelector(`select[data-option-position="${optionPosition}"]`);
        if (!select) return;
        
        const selectedValue = select.value;
        
        // Remove selected class from ALL size buttons for this option
        const allBtns = root.querySelectorAll(`.pgc-minimal__size-btn[data-option-position="${optionPosition}"]`);
        allBtns.forEach(btn => {
          btn.classList.remove('pgc-minimal__size-btn--selected');
        });
        
        // Add selected class to the button matching the selected value
        allBtns.forEach(btn => {
          if (btn.dataset.value === selectedValue) {
            btn.classList.add('pgc-minimal__size-btn--selected');
          }
        });
      }

      // Function to update all selected size buttons
      function updateAllSelectedSizeButtons() {
        const optionSelects = form.querySelectorAll('select[name^="options"]');
        optionSelects.forEach(select => {
          const optionPos = select.dataset.optionPosition;
          if (optionPos !== undefined && optionPos !== null) {
            updateSelectedSizeButtonForOption(optionPos);
          }
        });
      }

      // Handle size button clicks - use event delegation for reliability
      function handleSizeButtonClick(e) {
        const btn = e.target.closest('.pgc-minimal__size-btn');
        if (!btn) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const value = btn.dataset.value;
        const optionPos = btn.dataset.optionPosition;
        
        console.log('Size button clicked:', { value, optionPos, btn });
        
        // Check if optionPos exists (including "0")
        if (optionPos === undefined || optionPos === null || optionPos === '') {
          console.warn('Size button missing option position:', btn);
          return;
        }
        
        // Find the hidden select for this option
        const select = form.querySelector(`select[data-option-position="${optionPos}"]`);
        if (!select) {
          console.warn('Select not found for option position:', optionPos, 'Available selects:', form.querySelectorAll('select[name^="options"]'));
          return;
        }
        
        console.log('Found select:', select, 'Current value:', select.value, 'New value:', value);
        
        // Remove selected class from ALL buttons in this option group first
        const allBtns = root.querySelectorAll(`.pgc-minimal__size-btn[data-option-position="${optionPos}"]`);
        console.log('All buttons for option', optionPos, ':', allBtns.length);
        allBtns.forEach(b => {
          b.classList.remove('pgc-minimal__size-btn--selected');
        });
        
        // Add selected class to clicked button
        btn.classList.add('pgc-minimal__size-btn--selected');
        console.log('Button state updated');
        
        // Update hidden select value
        select.value = value;
        console.log('Select value updated to:', select.value);
        
        // Trigger change event to update variant
        const changeEvent = new Event('change', { bubbles: true, cancelable: true });
        select.dispatchEvent(changeEvent);
        console.log('Change event dispatched');
      }

      // Use event delegation on the form for better reliability
      if (form) {
        form.addEventListener('click', handleSizeButtonClick);
        console.log('Event listener attached to form for size buttons');
      }
      
      // Also attach directly to buttons as backup
      setTimeout(() => {
        const sizeButtons = root.querySelectorAll('.pgc-minimal__size-btn');
        console.log('Found', sizeButtons.length, 'size buttons');
        sizeButtons.forEach(btn => {
          // Remove any existing listeners by cloning
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          newBtn.addEventListener('click', handleSizeButtonClick);
          console.log('Event listener attached to button:', newBtn.dataset.value, 'optionPos:', newBtn.dataset.optionPosition);
        });
      }, 100);

      // Listen for variant changes and update button states
      optionSelects.forEach(select => {
        select.addEventListener('change', () => {
          updateVariant();
          const optionPos = select.dataset.optionPosition;
          if (optionPos !== undefined && optionPos !== null) {
            updateSelectedSizeButtonForOption(optionPos);
          }
        });
      });

      // Listen to variant-selects component events and update buttons
      if (variantSelects) {
        variantSelects.addEventListener('change', (e) => {
          const variantId = e.detail?.variant?.id || variantIdInput?.value;
          if (variantId && productData.variants) {
            const variant = productData.variants.find(v => v.id.toString() === variantId.toString());
            if (variant) {
              updateSizeAndPrice(variant);
              // Update all size buttons based on variant options
              updateAllSelectedSizeButtons();
            }
          }
        });
      }

      // Initial button state update
      setTimeout(() => {
        updateAllSelectedSizeButtons();
      }, 100);
      
      // Initial update
      updateVariant();
    }
  })();
</script>

{% schema %}
{
  "name": "Product glass card",
  "tag": "section",
  "settings": [
    { "type": "header", "content": "Layout" },
    { "type": "range", "id": "min_height", "min": 300, "max": 1200, "step": 20, "unit": "px", "label": "Section min height", "default": 700 },
    { "type": "range", "id": "container_width", "min": 600, "max": 1400, "step": 50, "unit": "px", "label": "Left content max width", "default": 1100 },
    { "type": "range", "id": "section_padding", "min": 20, "max": 140, "step": 10, "unit": "px", "label": "Top/bottom padding", "default": 60 },
    { "type": "range", "id": "side_padding", "min": 10, "max": 120, "step": 10, "unit": "px", "label": "Left/right padding", "default": 40 },

    { "type": "header", "content": "Middle word (fallback)" },
    { "type": "text", "id": "middle_text", "label": "Default middle text", "default": "DinoBoo" },
    { "type": "range", "id": "middle_width", "min": 0, "max": 260, "step": 10, "unit": "px", "label": "Middle space width", "default": 140 },
    { "type": "range", "id": "middle_text_shift", "min": -100, "max": 100, "step": 2, "unit": "px", "label": "Middle word shift (left/right)", "default": 0 },
    { "type": "range", "id": "inside_text_shift", "min": -100, "max": 100, "step": 2, "unit": "px", "label": "Inside word shift (left/right)", "default": 0 },
    { "type": "color", "id": "middle_text_color", "label": "Middle text color", "default": "#ffffff" },
    { "type": "range", "id": "middle_text_opacity", "min": 10, "max": 100, "step": 5, "unit": "%", "label": "Left opacity", "default": 90 },
    { "type": "range", "id": "middle_text_size", "min": 80, "max": 260, "step": 10, "unit": "px", "label": "Text size", "default": 200 },
    { "type": "range", "id": "middle_letter_spacing", "min": 0, "max": 12, "step": 1, "unit": "px", "label": "Letter spacing", "default": 2 },
    { "type": "range", "id": "middle_text_blur", "min": 0, "max": 8, "step": 1, "unit": "px", "label": "Left blur", "default": 0 },

    { "type": "range", "id": "word_left_cut", "min": 0, "max": 60, "step": 1, "unit": "%", "label": "Right part start (0-60)", "default": 25 },
    { "type": "range", "id": "word_right_cut", "min": 0, "max": 60, "step": 1, "unit": "%", "label": "Left part end (0-60)", "default": 25 },
    { "type": "range", "id": "word_inside_opacity", "min": 5, "max": 100, "step": 5, "unit": "%", "label": "Inside opacity", "default": 60 },
    { "type": "range", "id": "word_inside_blur", "min": 0, "max": 12, "step": 1, "unit": "px", "label": "Inside blur", "default": 4 },

    { "type": "header", "content": "Gallery" },
    { "type": "range", "id": "image_border_radius", "min": 0, "max": 40, "step": 2, "unit": "px", "label": "Image border radius", "default": 22 },

    { "type": "header", "content": "Glass card" },
    { "type": "range", "id": "glass_border_radius", "min": 0, "max": 60, "step": 2, "unit": "px", "label": "Glass border radius", "default": 0 },
    { "type": "range", "id": "glass_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "label": "Glass opacity", "default": 12 },
    { "type": "range", "id": "glass_blur", "min": 0, "max": 40, "step": 1, "unit": "px", "label": "Glass blur", "default": 26 },
    { "type": "range", "id": "glass_border_width", "min": 0, "max": 6, "step": 1, "unit": "px", "label": "Glass border width", "default": 2 },
    { "type": "range", "id": "glass_border_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "label": "Glass border opacity", "default": 60 },

    { "type": "header", "content": "Typography" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#0a0a0a" },
    { "type": "range", "id": "title_size", "min": 20, "max": 52, "step": 2, "unit": "px", "label": "Title size", "default": 32 },
    { "type": "range", "id": "price_size", "min": 16, "max": 44, "step": 2, "unit": "px", "label": "Price size", "default": 22 },

    { "type": "header", "content": "Button" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Add to cart" },
    { "type": "color", "id": "button_bg_color", "label": "Button background color", "default": "#000000" },
    { "type": "color", "id": "button_hover_bg_color", "label": "Button hover color", "default": "#333333" },
    { "type": "color", "id": "button_text_color", "label": "Button text color", "default": "#ffffff" },
    { "type": "range", "id": "button_border_radius", "min": 0, "max": 40, "step": 2, "unit": "px", "label": "Button border radius", "default": 12 },

    { "type": "header", "content": "Minimalist PDP" },
    { "type": "checkbox", "id": "append_color_option", "default": true, "label": "Append Color to title if option exists" },
    { "type": "text", "id": "fit_label", "default": "FIT", "label": "Fit area label" },
    { "type": "checkbox", "id": "show_selected_size", "default": true, "label": "Show selected size" },
    { "type": "text", "id": "fit_small_label", "default": "SMALL", "label": "Fit scale left label" },
    { "type": "text", "id": "fit_true_label", "default": "TRUE TO SIZE", "label": "Fit scale middle label" },
    { "type": "text", "id": "fit_large_label", "default": "LARGE", "label": "Fit scale right label" },
    { "type": "range", "id": "fit_position", "min": 0, "max": 100, "step": 1, "default": 50, "unit": "%", "label": "Fit marker position (%)", "info": "Tip: connect this to a product metafield using dynamic sources for per-product fit." },
    { "type": "text", "id": "description_heading", "default": "DESCRIPTION", "label": "Description accordion heading" },
    { "type": "text", "id": "shipping_heading", "default": "SHIPPING AND RETURNS", "label": "Shipping & Returns accordion heading" }
  ],
  "presets": [
    { "name": "Product glass card" }
  ]
}
{% endschema %}
