{%- liquid
  assign id = section.id
  assign slides = section.blocks
-%}

<style>
.carousel-arc-{{ id }} {
  background: #fff;
  padding: 80px 0;
  overflow: hidden;
}

.carousel-arc-scene-{{ id }} {
  perspective: 1800px;
  perspective-origin: center center;
  display: flex;
  justify-content: center;
  transform-style: preserve-3d;
}

.carousel-arc-track-{{ id }} {
  position: relative;
  width: 420px;
  height: 560px;
  transform-style: preserve-3d;
}

.carousel-arc-item-{{ id }} {
  position: absolute;
  inset: 0;
  border-radius: 16px;
  overflow: hidden;
  transform-origin: center center;
  transition:
    transform 1.1s cubic-bezier(0.23, 1, 0.32, 1),
    opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  backface-visibility: hidden;
}

.carousel-arc-item-{{ id }} img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Mobile */
@media (max-width: 768px) {
  .carousel-arc-track-{{ id }} {
    width: 280px;
    height: 400px;
  }
}
</style>

<section class="carousel-arc-{{ id }}">
  <div class="carousel-arc-scene-{{ id }}">
    <div class="carousel-arc-track-{{ id }}" data-track>
      {%- for block in slides -%}
        <div
          class="carousel-arc-item-{{ id }}"
          data-index="{{ forloop.index0 }}">
          {%- if block.settings.image != blank -%}
            <img
              src="{{ block.settings.image | image_url: width: 1200 }}"
              alt="{{ block.settings.image.alt | escape }}"
              loading="lazy">
          {%- else -%}
            <div style="width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999; border-radius: 16px;">
              {{ 'image' | placeholder_svg_tag: 'placeholder' }}
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  </div>
</section>

<script>
(() => {
  const track = document.querySelector('[data-track]');
  if (!track) return;

  const items = [...track.children];
  const total = items.length;

  if (total === 0) return;

  let active = 0;

  const ANGLE = 20;     // tilt
  const OFFSET = 140;  // horizontal spacing
  const DEPTH = 280;   // Z depth

  function render() {
    items.forEach((item, i) => {
      const diff = i - active;
      const abs = Math.abs(diff);

      if (abs > 3) {
        item.style.opacity = 0;
        item.style.pointerEvents = 'none';
        item.style.zIndex = 0;
        return;
      }

      // Calculate scale based on distance from center
      let scale;
      if (abs === 0) {
        scale = 1;
      } else if (abs === 1) {
        scale = 0.85;
      } else if (abs === 2) {
        scale = 0.72;
      } else {
        scale = 0.65;
      }

      // Calculate z-index based on distance from center
      let zIndex;
      if (abs === 0) {
        zIndex = 5;
      } else if (abs === 1) {
        zIndex = 4;
      } else if (abs === 2) {
        zIndex = 3;
      } else {
        zIndex = 2;
      }

      // Fade out items at the edges
      let opacity = 1;
      if (abs === 3) {
        opacity = 0.5;
      }

      item.style.opacity = opacity;
      item.style.pointerEvents = 'auto';
      item.style.zIndex = zIndex;

      item.style.transform = `
        translateX(${diff * OFFSET}px)
        translateZ(${-abs * DEPTH}px)
        rotateY(${diff * ANGLE}deg)
        scale(${scale})
      `;
    });
  }

  function next() {
    active = (active + 1) % total;
    render();
  }

  // Pause on hover
  const section = track.closest('section');
  if (section) {
    let isPaused = false;
    let autoplayTimer = null;

    function startAutoplay() {
      if (isPaused) return;
      stopAutoplay();
      autoplayTimer = setInterval(next, 3200);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    section.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoplay();
    });

    section.addEventListener('mouseleave', () => {
      isPaused = false;
      startAutoplay();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const rect = section.getBoundingClientRect();
      if (rect.top < window.innerHeight && rect.bottom > 0) {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          active = (active - 1 + total) % total;
          render();
          stopAutoplay();
          setTimeout(startAutoplay, 2000);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          next();
          stopAutoplay();
          setTimeout(startAutoplay, 2000);
        }
      }
    });

    render();
    startAutoplay();

    // Cleanup on section unload
    document.addEventListener('shopify:section:unload', function(e) {
      if (e.detail.sectionId === '{{ id }}') {
        stopAutoplay();
      }
    });
  } else {
    render();
    setInterval(next, 3200);
  }
})();
</script>

{% schema %}
{
  "name": "3D Arc Carousel",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Arc Carousel",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
