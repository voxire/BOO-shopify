{%- liquid
  assign section_id = section.id
  assign slides = section.blocks | where: 'type', 'slide'
  assign autoplay_enabled = section.settings.autoplay_enabled
  assign autoplay_speed = section.settings.autoplay_speed | default: 3500
  assign total_slides = slides.size
-%}

{%- style -%}
  /* Section-scoped styles */
  .carousel-3d-{{ section_id }} {
    position: relative;
    width: 100%;
    padding: 6rem 0;
    background: #ffffff;
    overflow: hidden;
  }

  .carousel-3d-scene-{{ section_id }} {
    position: relative;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    perspective: 1600px;
    perspective-origin: center center;
    min-height: 600px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-3d-ring-{{ section_id }} {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-3d-item-{{ section_id }} {
    position: absolute;
    width: 380px;
    max-width: 85vw;
    height: auto;
    transform-style: preserve-3d;
    backface-visibility: hidden;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .carousel-3d-item-{{ section_id }} img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
    border-radius: 12px;
  }

  /* Responsive adjustments for mobile */
  @media screen and (max-width: 768px) {
    .carousel-3d-{{ section_id }} {
      padding: 4rem 0;
    }

    .carousel-3d-scene-{{ section_id }} {
      perspective: 1000px;
      min-height: 450px;
    }

    .carousel-3d-item-{{ section_id }} {
      width: 280px;
      max-width: 80vw;
      border-radius: 10px;
    }

    .carousel-3d-item-{{ section_id }} img {
      border-radius: 10px;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .carousel-3d-item-{{ section_id }} {
      transition: none;
    }

    .carousel-3d-scene-{{ section_id }} {
      perspective: none;
    }
  }
{%- endstyle -%}

<section class="carousel-3d-{{ section_id }}" data-section-id="{{ section_id }}" data-carousel-3d>
  <div class="carousel-3d-scene-{{ section_id }}" data-scene>
    <div class="carousel-3d-ring-{{ section_id }}" data-ring>
      {%- for block in slides -%}
        {%- liquid
          assign slide_index = forloop.index0
          assign image = block.settings.image
        -%}
        <div class="carousel-3d-item-{{ section_id }}" 
             data-item 
             data-index="{{ slide_index }}"
             style="--i: {{ slide_index }};">
          {%- if image != blank -%}
            <img src="{{ image | image_url: width: 1600 }}" 
                 srcset="{{ image | image_url: width: 800 }} 800w,
                         {{ image | image_url: width: 1200 }} 1200w,
                         {{ image | image_url: width: 1600 }} 1600w"
                 sizes="(max-width: 768px) 280px, 380px"
                 alt="{{ image.alt | escape }}"
                 loading="lazy">
          {%- else -%}
            <div style="width: 100%; aspect-ratio: 3/4; background: #f5f5f5; 
                       display: flex; align-items: center; justify-content: center; 
                       color: #999; border-radius: 12px;">
              {{ 'image' | placeholder_svg_tag: 'placeholder' }}
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  </div>
</section>

<script>
  (function() {
    'use strict';
    
    const sectionId = '{{ section_id }}';
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!section) return;
    
    const ring = section.querySelector('[data-ring]');
    const items = section.querySelectorAll('[data-item]');
    const totalSlides = items.length;
    
    if (totalSlides === 0) return;
    
    // Check for reduced motion
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    // Fixed arc parameters
    let maxAngle = 60; // Total arc spread in degrees (max 80)
    let angle = totalSlides > 1 ? maxAngle / (totalSlides - 1) : 0;
    
    // Radius settings
    let radius = 260; // Desktop default
    let mobileRadius = 170; // Mobile default
    
    function updateDimensions() {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        radius = mobileRadius;
        maxAngle = 50; // Smaller arc on mobile
      } else {
        radius = 260;
        maxAngle = 60;
      }
      angle = totalSlides > 1 ? maxAngle / (totalSlides - 1) : 0;
      updateItemPositions();
    }
    
    let currentIndex = 0;
    let autoplayTimer = null;
    let isPaused = false;
    
    // Update item positions (limited arc, not full ring)
    function updateItemPositions() {
      if (prefersReducedMotion) return;
      
      items.forEach((item, index) => {
        const diff = index - currentIndex;
        const absDiff = Math.abs(diff);
        
        // Calculate rotation: (index - activeIndex) * angle
        const rotation = diff * angle;
        
        // Apply transform: rotateY(rotation) translateZ(radius)
        item.style.transform = `rotateY(${rotation}deg) translateZ(${radius}px)`;
        
        // Visibility: items farther than Â±2 from activeIndex are hidden
        if (absDiff > 2) {
          item.style.opacity = '0';
          item.style.pointerEvents = 'none';
        } else {
          item.style.opacity = '1';
          item.style.pointerEvents = 'auto';
        }
      });
    }
    
    // Navigate to next slide
    function nextSlide() {
      if (prefersReducedMotion) return;
      currentIndex = (currentIndex + 1) % totalSlides;
      updateItemPositions();
    }
    
    // Navigate to previous slide
    function prevSlide() {
      if (prefersReducedMotion) return;
      currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
      updateItemPositions();
    }
    
    // Update dimensions on resize
    window.addEventListener('resize', updateDimensions);
    
    // Auto-rotate functionality
    const autoplayEnabled = {{ autoplay_enabled | json }};
    const autoplaySpeed = {{ autoplay_speed | json }};
    
    function startAutoplay() {
      if (!autoplayEnabled || prefersReducedMotion || isPaused) return;
      
      stopAutoplay();
      autoplayTimer = setInterval(() => {
        if (!isPaused) {
          nextSlide();
        }
      }, autoplaySpeed);
    }
    
    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }
    
    // Pause on hover
    section.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoplay();
    });
    
    section.addEventListener('mouseleave', () => {
      isPaused = false;
      if (autoplayEnabled && !prefersReducedMotion) {
        startAutoplay();
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const rect = section.getBoundingClientRect();
      if (rect.top < window.innerHeight && rect.bottom > 0) {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevSlide();
          stopAutoplay();
          setTimeout(() => {
            if (autoplayEnabled && !prefersReducedMotion) {
              startAutoplay();
            }
          }, 2000);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          nextSlide();
          stopAutoplay();
          setTimeout(() => {
            if (autoplayEnabled && !prefersReducedMotion) {
              startAutoplay();
            }
          }, 2000);
        }
      }
    });
    
    // Initialize
    function initializeCarousel() {
      updateDimensions();
      
      if (autoplayEnabled && !prefersReducedMotion) {
        startAutoplay();
      }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCarousel);
    } else {
      // Small delay to ensure layout is ready
      setTimeout(initializeCarousel, 100);
    }
    
    // Cleanup on section unload
    document.addEventListener('shopify:section:unload', function(e) {
      if (e.detail.sectionId === sectionId) {
        stopAutoplay();
      }
    });
    
    // Reinitialize on section load (theme editor)
    document.addEventListener('shopify:section:load', function(e) {
      if (e.detail.sectionId === sectionId) {
        setTimeout(initializeCarousel, 100);
      }
    });
  })();
</script>

{% schema %}
{
  "name": "3D Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "autoplay_enabled",
      "label": "Enable autoplay",
      "default": true,
      "info": "Automatically rotate slides every few seconds"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2000,
      "max": 5000,
      "step": 500,
      "unit": "ms",
      "label": "Autoplay speed",
      "default": 3500,
      "info": "Time between slides (3.5 seconds default)"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Carousel",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
