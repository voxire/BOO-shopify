{%- liquid
  assign section_id = section.id
  assign heading = section.settings.heading
  assign product_source = section.settings.product_source
  assign collection = collections[section.settings.collection]
  assign card_size = section.settings.card_size
  assign autoplay_enabled = section.settings.autoplay_enabled
  assign autoplay_speed = section.settings.autoplay_speed
  assign padding_top = section.settings.padding_top
  assign padding_bottom = section.settings.padding_bottom
  assign manual_products = section.blocks | where: 'type', 'product'
-%}

{%- style -%}
  .related-products-{{ section_id }} {
    padding-top: {{ padding_top | times: 0.5 | round: 0 }}px;
    padding-bottom: {{ padding_bottom | times: 0.5 | round: 0 }}px;
    background-color: {{ section.settings.background_color }};
  }

  @media screen and (min-width: 750px) {
    .related-products-{{ section_id }} {
      padding-top: {{ padding_top }}px;
      padding-bottom: {{ padding_bottom }}px;
    }
  }

  .related-products-{{ section_id }}__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .related-products-{{ section_id }}__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }

  .related-products-{{ section_id }}__heading {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    color: {{ section.settings.text_color }};
  }


  .related-products-{{ section_id }}__navigation {
    display: none;
    gap: 0.5rem;
  }

  @media screen and (min-width: 990px) {
    .related-products-{{ section_id }}__navigation {
      display: flex;
    }
  }

  .related-products-{{ section_id }}__nav-button {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.2);
    background: #ffffff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }

  .related-products-{{ section_id }}__nav-button:hover {
    transform: scale(1.05);
    opacity: 0.8;
  }

  .related-products-{{ section_id }}__nav-button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .related-products-{{ section_id }}__nav-button svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
  }

  .related-products-{{ section_id }}__viewport {
    position: relative;
    overflow: hidden;
  }

  .related-products-{{ section_id }}__track {
    display: flex;
    gap: 1.5rem;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }

  @media screen and (max-width: 989px) {
    .related-products-{{ section_id }}__viewport {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      width: 100%;
    }

    .related-products-{{ section_id }}__viewport::-webkit-scrollbar {
      display: none;
    }

    .related-products-{{ section_id }}__track {
      display: flex;
      gap: 1.5rem;
      scroll-snap-type: x mandatory;
      transform: none !important;
      will-change: auto;
    }
  }

  .related-products-{{ section_id }}__card {
    flex: 0 0 {% if card_size == 'small' %}280px{% elsif card_size == 'medium' %}320px{% else %}360px{% endif %};
    scroll-snap-align: start;
  }

  @media screen and (max-width: 768px) {
    .related-products-{{ section_id }} {
      width: 100%;
      overflow-x: hidden;
    }

    .related-products-{{ section_id }}__container {
      padding: 0 1rem;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .related-products-{{ section_id }}__header {
      margin-bottom: 1.5rem;
      width: 100%;
      flex-wrap: wrap;
    }

    .related-products-{{ section_id }}__heading {
      font-size: 1.75rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      flex: 1;
      min-width: 0;
    }

    .related-products-{{ section_id }}__viewport {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .related-products-{{ section_id }}__viewport::-webkit-scrollbar {
      display: none;
    }

    .related-products-{{ section_id }}__track {
      display: flex;
      gap: 1rem;
      transform: none !important;
      will-change: auto;
      scroll-snap-type: x mandatory;
    }

    .related-products-{{ section_id }}__card {
      flex: 0 0 75vw;
      min-width: 75vw;
      max-width: 75vw;
      scroll-snap-align: start;
    }

    .related-products-{{ section_id }}__image-wrapper {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .related-products-{{ section_id }}__image {
      width: 100%;
      max-width: 100%;
      height: 100%;
      object-fit: cover;
      transform: none;
    }

    .related-products-{{ section_id }}__product-link:hover .related-products-{{ section_id }}__image {
      transform: none;
    }

    .related-products-{{ section_id }}__title {
      font-size: 1rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .related-products-{{ section_id }}__price {
      font-size: 0.9rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  }

  .related-products-{{ section_id }}__product-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .related-products-{{ section_id }}__image-wrapper {
    position: relative;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    border-radius: 12px;
    background: #f5f5f5;
    margin-bottom: 1rem;
  }

  .related-products-{{ section_id }}__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .related-products-{{ section_id }}__product-link:hover .related-products-{{ section_id }}__image {
    transform: scale(1.05);
  }

  .related-products-{{ section_id }}__info {
    text-align: center;
  }

  .related-products-{{ section_id }}__title {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
    font-weight: 500;
    color: {{ section.settings.text_color }};
  }

  .related-products-{{ section_id }}__price {
    margin: 0;
    font-size: 1rem;
    color: {{ section.settings.text_color }};
    opacity: 0.7;
  }
{%- endstyle -%}

<section class="related-products-{{ section_id }}" data-section-id="{{ section.id }}">
  <div class="related-products-{{ section_id }}__container">
    {%- if heading != blank -%}
      <div class="related-products-{{ section_id }}__header">
        <h2 class="related-products-{{ section_id }}__heading">{{ heading }}</h2>
        <div class="related-products-{{ section_id }}__navigation">
          <button class="related-products-{{ section_id }}__nav-button" aria-label="Previous" data-carousel-prev>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <button class="related-products-{{ section_id }}__nav-button" aria-label="Next" data-carousel-next>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
    {%- endif -%}

    <div class="related-products-{{ section_id }}__viewport">
      <div class="related-products-{{ section_id }}__track" data-carousel-track>
        {%- assign product_image_class = 'related-products-' | append: section_id | append: '__image' -%}
        {%- if product_source == 'collection' and collection != blank -%}
          {%- for product in collection.products limit: 12 -%}
            <div class="related-products-{{ section_id }}__card">
              <a href="{{ product.url }}" class="related-products-{{ section_id }}__product-link">
                <div class="related-products-{{ section_id }}__image-wrapper">
                  {%- if product.featured_media != blank -%}
                    {{ product.featured_media | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title, class: product_image_class }}
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: product_image_class }}
                  {%- endif -%}
                </div>
                <div class="related-products-{{ section_id }}__info">
                  <h3 class="related-products-{{ section_id }}__title">{{ product.title }}</h3>
                  <p class="related-products-{{ section_id }}__price">{{ product.price | money }}</p>
                </div>
              </a>
            </div>
          {%- endfor -%}
        {%- elsif product_source == 'manual' -%}
          {%- for block in manual_products -%}
            {%- assign product = all_products[block.settings.product] -%}
            {%- if product != blank -%}
              <div class="related-products-{{ section_id }}__card" {{ block.shopify_attributes }}>
                <a href="{{ product.url }}" class="related-products-{{ section_id }}__product-link">
                  <div class="related-products-{{ section_id }}__image-wrapper">
                    {%- if product.featured_media != blank -%}
                      {{ product.featured_media | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title, class: product_image_class }}
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: product_image_class }}
                    {%- endif -%}
                  </div>
                  <div class="related-products-{{ section_id }}__info">
                    <h3 class="related-products-{{ section_id }}__title">{{ product.title }}</h3>
                    <p class="related-products-{{ section_id }}__price">{{ product.price | money }}</p>
                  </div>
                </a>
              </div>
            {%- endif -%}
          {%- endfor -%}
        {%- else -%}
          {%- comment -%} Fallback to product recommendations {%- endcomment -%}
          {%- for product in product.recommendations.products limit: 12 -%}
            <div class="related-products-{{ section_id }}__card">
              <a href="{{ product.url }}" class="related-products-{{ section_id }}__product-link">
                <div class="related-products-{{ section_id }}__image-wrapper">
                  {%- if product.featured_media != blank -%}
                    {{ product.featured_media | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title, class: product_image_class }}
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: product_image_class }}
                  {%- endif -%}
                </div>
                <div class="related-products-{{ section_id }}__info">
                  <h3 class="related-products-{{ section_id }}__title">{{ product.title }}</h3>
                  <p class="related-products-{{ section_id }}__price">{{ product.price | money }}</p>
                </div>
              </a>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>
    </div>
  </div>
</section>


<script>
  (function() {
    const section = document.querySelector('.related-products-{{ section_id }}');
    if (!section) return;

    const track = section.querySelector('[data-carousel-track]');
    const prevButton = section.querySelector('[data-carousel-prev]');
    const nextButton = section.querySelector('[data-carousel-next]');
    const cards = section.querySelectorAll('.related-products-{{ section_id }}__card');
    
    if (!track || cards.length === 0) return;

    let currentIndex = 0;
    const cardWidth = cards[0].offsetWidth + 24; // card width + gap
    const maxIndex = cards.length - 1;

    function updateButtons() {
      if (prevButton) prevButton.disabled = currentIndex === 0;
      if (nextButton) nextButton.disabled = currentIndex >= maxIndex;
    }

    function scrollToIndex(index) {
      if (index < 0 || index > maxIndex) return;
      currentIndex = index;
      
      // Mobile: use scrollIntoView instead of transform
      if (window.innerWidth <= 768) {
        if (cards[index]) {
          cards[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
        }
      } else {
        const scrollAmount = index * cardWidth;
        track.style.transform = `translateX(-${scrollAmount}px)`;
      }
      updateButtons();
    }

    if (prevButton) {
      prevButton.addEventListener('click', () => scrollToIndex(currentIndex - 1));
    }

    if (nextButton) {
      nextButton.addEventListener('click', () => scrollToIndex(currentIndex + 1));
    }

    // Autoplay
    {% if autoplay_enabled %}
      let autoplayInterval;
      function startAutoplay() {
        autoplayInterval = setInterval(() => {
          if (currentIndex >= maxIndex) {
            scrollToIndex(0);
          } else {
            scrollToIndex(currentIndex + 1);
          }
        }, {{ autoplay_speed }});
      }

      function stopAutoplay() {
        clearInterval(autoplayInterval);
      }

      startAutoplay();

      // Pause on hover
      section.addEventListener('mouseenter', stopAutoplay);
      section.addEventListener('mouseleave', startAutoplay);
    {% endif %}

    // Mobile swipe
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    track.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          scrollToIndex(Math.min(currentIndex + 1, maxIndex));
        } else {
          scrollToIndex(Math.max(currentIndex - 1, 0));
        }
      }
    }

    updateButtons();

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth > 768) {
          scrollToIndex(currentIndex);
        } else {
          // Reset transform on mobile
          track.style.transform = 'none';
        }
      }, 250);
    });
  })();
</script>


{% schema %}
{
  "name": "Related Products Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You Might Also Like"
    },
    {
      "type": "select",
      "id": "product_source",
      "label": "Product Source",
      "options": [
        {
          "value": "collection",
          "label": "Collection"
        },
        {
          "value": "manual",
          "label": "Manual Selection"
        },
        {
          "value": "recommendations",
          "label": "Product Recommendations"
        }
      ],
      "default": "recommendations"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Required if Product Source is 'Collection'"
    },
    {
      "type": "select",
      "id": "card_size",
      "label": "Card Size",
      "options": [
        {
          "value": "small",
          "label": "Small (280px)"
        },
        {
          "value": "medium",
          "label": "Medium (320px)"
        },
        {
          "value": "large",
          "label": "Large (360px)"
        }
      ],
      "default": "medium"
    },
    {
      "type": "checkbox",
      "id": "autoplay_enabled",
      "label": "Enable Autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2000,
      "max": 8000,
      "step": 500,
      "unit": "ms",
      "label": "Autoplay Speed",
      "default": 4000
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Related Products Carousel"
    }
  ]
}
{% endschema %}

