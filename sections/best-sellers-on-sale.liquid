{%- liquid
  assign section_id = section.id
  assign heading = section.settings.heading | default: 'Best Sellers on Sale'
  assign button_label = section.settings.button_label | default: 'SHOP NOW'
  assign button_link = section.settings.button_link | default: '#'
  assign badge_text = section.settings.badge_text | default: 'Best Seller'
  assign badge_tag = section.settings.badge_tag | default: 'Best Seller'
  assign section_bg = section.settings.section_bg | default: '#ffffff'
  assign card_bg = section.settings.card_bg | default: '#f3f3f3'
  assign button_bg = section.settings.button_bg | default: '#b7aca4'
  assign button_text = section.settings.button_text | default: '#ffffff'
  assign badge_bg = section.settings.badge_bg | default: '#d8d0c8'
  assign badge_text_color = section.settings.badge_text_color | default: '#4b4b4b'
  assign top_cta_1_label = section.settings.top_cta_1_label | default: 'SHOP BEST SELLERS'
  assign top_cta_2_label = section.settings.top_cta_2_label | default: 'SHOP ALL AW25'
  assign top_cta_bg = section.settings.top_cta_bg | default: button_bg
  assign top_cta_text = section.settings.top_cta_text | default: button_text
  assign card_height_desktop = section.settings.card_height_desktop | default: 520
  assign card_height_tablet = section.settings.card_height_tablet | default: 460
  assign card_height_mobile = section.settings.card_height_mobile | default: 440
  assign image_max_width = section.settings.image_max_width | default: 900

  comment
    Extract age range values from button labels for filter matching
    Pattern: "Age 0.5-4" -> "0.5-4", "AGE 5-7" -> "5-7"
  endcomment
  assign age_range_1 = 'all'
  if top_cta_1_label != blank
    assign age_range_1 = top_cta_1_label | replace: 'Age ', '' | replace: 'AGE ', '' | replace: 'age ', '' | strip | downcase
  endif
  assign age_range_2 = 'all'
  if top_cta_2_label != blank
    assign age_range_2 = top_cta_2_label | replace: 'Age ', '' | replace: 'AGE ', '' | replace: 'age ', '' | strip | downcase
  endif
-%}

<section
  class="best-sellers-on-sale best-sellers-on-sale--{{ section_id }}"
  data-section-id="{{ section_id }}"
  style="background-color: {{ section_bg }};"
>
  <div class="page-width">
    {%- comment -%} Age Filter Buttons - matches SCG pattern {%- endcomment -%}
    <div class="best-sellers-on-sale__top-ctas" role="tablist" aria-label="Product filter tabs">
      <button type="button" class="best-sellers-on-sale__top-cta is-active" data-filter="all" role="tab" aria-selected="true">ALL</button>
      {%- if top_cta_1_label != blank -%}
        <button type="button" class="best-sellers-on-sale__top-cta" data-filter="{{ age_range_1 }}" role="tab" aria-selected="false">{{ top_cta_1_label }}</button>
      {%- endif -%}
      {%- if top_cta_2_label != blank -%}
        <button type="button" class="best-sellers-on-sale__top-cta" data-filter="{{ age_range_2 }}" role="tab" aria-selected="false">{{ top_cta_2_label }}</button>
      {%- endif -%}
    </div>

    <div class="best-sellers-on-sale__header">
      {%- if heading != blank -%}
        <h2 class="best-sellers-on-sale__heading">{{ heading }}</h2>
      {%- endif -%}
      {%- if button_label != blank -%}
        <span class="best-sellers-on-sale__button">
          {{ button_label }} â†’
        </span>
      {%- endif -%}
    </div>

    {%- comment -%} Product Grid - rendered from section blocks (not collection) {%- endcomment -%}
    {%- assign blocks_with_products = section.blocks | where: 'type', 'product_card' -%}
    {%- if blocks_with_products.size > 0 -%}
      <div class="best-sellers-on-sale__grid" id="best-sellers-grid-{{ section_id }}">
        {%- for block in blocks_with_products -%}
          {%- assign product = block.settings.product -%}
          {%- if product != blank -%}
            {%- liquid
              comment
                Sale detection - check if product has compare_at_price > price
              endcomment
              assign is_on_sale = false
              if product.compare_at_price_max > product.price
                assign is_on_sale = true
              endif

              comment
                Badge tag detection - check if product has the specified badge tag
              endcomment
              assign has_badge_tag = false
              if badge_tag == blank
                assign has_badge_tag = true
              else
                assign badge_tag_lower = badge_tag | downcase
                for tag in product.tags
                  assign tag_lower = tag | downcase
                  if tag_lower == badge_tag_lower
                    assign has_badge_tag = true
                    break
                  endif
                endfor
              endif

              assign show_badge = false
              if has_badge_tag and badge_text != blank
                assign show_badge = true
              endif

              comment
                Image selection: custom image from block, or product featured image
              endcomment
              assign product_image = block.settings.custom_image
              if product_image == blank
                assign product_image = product.featured_image
              endif
              if product_image == blank
                assign product_image = product.images.first
              endif

              comment
                Age range comes directly from block settings (not from product tags)
              endcomment
              assign product_age_range = block.settings.age_range | default: 'all' | downcase | strip
            -%}
            <div 
              class="best-sellers-on-sale__card" 
              data-sale="{{ is_on_sale }}" 
              data-badge="{{ has_badge_tag }}" 
              data-age-range="{{ product_age_range }}"
              {{ block.shopify_attributes }}
            >
              {%- if show_badge -%}
                <div class="best-sellers-on-sale__badge" style="background-color: {{ badge_bg }}; color: {{ badge_text_color }};">
                  {{ badge_text }}
                </div>
              {%- endif -%}

              {%- assign first_variant = product.selected_or_first_available_variant -%}

              <div class="best-sellers-on-sale__media">
                {%- if product_image != blank -%}
                  {%- assign image_width_2x = image_max_width | times: 2 -%}
                  {%- assign image_1x_url = product_image | image_url: width: image_max_width -%}
                  {%- assign image_2x_url = product_image | image_url: width: image_width_2x -%}

                  <a href="{{ product.url }}" class="best-sellers-on-sale__image-link" aria-label="{{ product.title | escape }}">
                    <img
                      src="{{ image_1x_url }}"
                      srcset="{{ image_1x_url }} 1x, {{ image_2x_url }} 2x"
                      alt="{{ product_image.alt | default: product.title | escape }}"
                      loading="lazy"
                      class="best-sellers-on-sale__image"
                    >
                  </a>
                {%- else -%}
                  <div class="best-sellers-on-sale__placeholder">
                    {{ 'product-1' | placeholder_svg_tag: 'best-sellers-on-sale__placeholder-svg' }}
                  </div>
                {%- endif -%}

                <!-- Hover / Tap overlay -->
                <div class="best-sellers-on-sale__overlay" aria-hidden="true">
                  <div class="best-sellers-on-sale__overlay-content">
                    <div class="best-sellers-on-sale__overlay-title">{{ product.title }}</div>

                    <div class="best-sellers-on-sale__overlay-price">
                      {%- if first_variant.compare_at_price and first_variant.compare_at_price > first_variant.price -%}
                        <span class="best-sellers-on-sale__price--sale">{{ first_variant.price | money }}</span>
                        <span class="best-sellers-on-sale__price--compare">{{ first_variant.compare_at_price | money }}</span>
                      {%- else -%}
                        <span class="best-sellers-on-sale__price">{{ first_variant.price | money }}</span>
                      {%- endif -%}
                    </div>

                    <button
                      type="button"
                      class="best-sellers-on-sale__atc"
                      data-variant-id="{{ first_variant.id }}"
                      {% unless first_variant.available %}disabled{% endunless %}
                      aria-label="{% if first_variant.available %}Add {{ product.title | escape }} to cart{% else %}Sold out{% endif %}"
                    >
                      {% if first_variant.available %}Add to cart{% else %}Sold out{% endif %}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
      <div class="best-sellers-on-sale__empty" id="best-sellers-empty-{{ section_id }}" style="display: none;">
        <p>{{ 'sections.best_sellers_on_sale.no_products' | t | default: 'No products found.' }}</p>
      </div>
    {%- else -%}
      <div class="best-sellers-on-sale__empty">
        <p>{{ 'sections.best_sellers_on_sale.no_products' | t | default: 'No products found.' }}</p>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  .best-sellers-on-sale--{{ section_id }} {
    padding-top: 40px;
    padding-bottom: 40px;
  }

  .best-sellers-on-sale__header {
    margin-bottom: 40px;
  }

  .best-sellers-on-sale__heading {
    font-family: serif;
    font-size: 22px;
    font-weight: normal;
    line-height: 1.3;
    margin: 0 0 16px 0;
    text-align: left;
  }

  .best-sellers-on-sale__button {
    display: inline-block;
    padding: 10px 20px;
    background-color: {{ button_bg }};
    color: {{ button_text }};
    text-decoration: none;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .best-sellers-on-sale__button:hover {
    opacity: 0.8;
  }

  .best-sellers-on-sale__top-ctas {
    display: flex;
    justify-content: center;
    gap: 14px;
    margin: 6px 0 22px;
    flex-wrap: wrap;
  }

  .best-sellers-on-sale__top-cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    background: {{ top_cta_bg }};
    color: {{ top_cta_text }};
    text-decoration: none;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.6px;
    font-weight: 600;
    border-radius: 0;
    white-space: nowrap;
    transition: opacity 0.2s;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .best-sellers-on-sale__top-cta:hover {
    opacity: 0.8;
  }

  .best-sellers-on-sale__top-cta.is-active {
    opacity: 1;
    outline: 2px solid {{ top_cta_text }};
    outline-offset: 2px;
  }

  .best-sellers-on-sale__grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 24px;
    width: 100%;
  }

  .best-sellers-on-sale__card {
    position: relative;
    background-color: {{ card_bg }};
    border-radius: 2px;
    height: {{ card_height_desktop }}px;
    padding: 0;              /* remove inner padding to eliminate white space */
    overflow: hidden;         /* crop image to card */
    display: block;           /* no flex centering */
    width: 100%;
    transition: opacity 0.4s ease, filter 0.4s ease;
  }

  {%- comment -%} Filtered out cards are blurred and faded via JS {%- endcomment -%}
  .best-sellers-on-sale__card.best-sellers-on-sale__card--filtered-out {
    opacity: 0.25;
    filter: blur(4px);
    pointer-events: none;
    transition: opacity 0.4s ease, filter 0.4s ease;
  }

  .best-sellers-on-sale__badge {
    position: absolute;
    top: 14px;
    left: 14px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.3px;
    z-index: 3;               /* ensure above overlay */
  }

  .best-sellers-on-sale__media {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .best-sellers-on-sale__image-link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .best-sellers-on-sale__image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;        /* full-bleed cover */
    object-position: center;
    transform: scale(1);
    transition: transform 0.35s ease;
  }

  .best-sellers-on-sale__card:hover .best-sellers-on-sale__image {
    transform: scale(1.03);
  }

  .best-sellers-on-sale__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    justify-content: stretch;
    padding: 18px;
    background: linear-gradient(to top, rgba(0,0,0,0.72), rgba(0,0,0,0.15), rgba(0,0,0,0));
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 2;
  }

  .best-sellers-on-sale__overlay-content {
    width: 100%;
    color: #fff;
    display: grid;
    gap: 10px;
  }

  .best-sellers-on-sale__overlay-title {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.25;
    letter-spacing: 0.2px;
    text-transform: none;
  }

  .best-sellers-on-sale__overlay-price {
    display: flex;
    gap: 10px;
    align-items: baseline;
    font-size: 13px;
  }

  .best-sellers-on-sale__price--sale {
    font-weight: 700;
  }

  .best-sellers-on-sale__price--compare {
    opacity: 0.7;
    text-decoration: line-through;
    font-size: 12px;
  }

  .best-sellers-on-sale__atc {
    width: 100%;
    border: none;
    cursor: pointer;
    padding: 12px 14px;
    border-radius: 6px;
    background: {{ button_bg }};
    color: {{ button_text }};
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.6px;
    text-transform: uppercase;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .best-sellers-on-sale__atc:hover {
    opacity: 0.92;
    transform: translateY(-1px);
  }

  .best-sellers-on-sale__atc:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .best-sellers-on-sale__card:hover .best-sellers-on-sale__overlay {
    opacity: 1;
    pointer-events: auto;
  }

  .best-sellers-on-sale__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .best-sellers-on-sale__placeholder-svg {
    width: 60%;
    height: 60%;
    opacity: 0.3;
  }

  .best-sellers-on-sale__empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  @media (min-width: 750px) and (max-width: 989px) {
    .best-sellers-on-sale__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 24px;
    }

    .best-sellers-on-sale__card {
      height: {{ card_height_tablet }}px;
    }
  }

  @media (max-width: 749px) {
    .best-sellers-on-sale--{{ section_id }} {
      padding-top: 24px;
      padding-bottom: 24px;
    }

    .best-sellers-on-sale__header {
      margin-bottom: 24px;
    }

    .best-sellers-on-sale__heading {
      font-size: 20px;
    }

    .best-sellers-on-sale__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .best-sellers-on-sale__card {
      height: {{ card_height_mobile }}px;
    }

    .best-sellers-on-sale__overlay {
      opacity: 1;
      pointer-events: auto;
    }
  }

  @media (max-width: 480px) {
    .best-sellers-on-sale__grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  (function() {
    const sectionId = '{{ section_id }}';
    const section = document.querySelector('[data-section-id="' + sectionId + '"]');
    if (!section) return;

    const grid = section.querySelector('#best-sellers-grid-' + sectionId);
    const emptyState = section.querySelector('#best-sellers-empty-' + sectionId);
    const filterButtons = section.querySelectorAll('.best-sellers-on-sale__top-cta[data-filter]');
    const cards = grid ? grid.querySelectorAll('.best-sellers-on-sale__card') : [];

    if (!grid || filterButtons.length === 0) return;

    let currentFilter = null;

    {%- comment -%} Filter function - matches SCG pattern exactly {%- endcomment -%}
    function filterByAge(ageRange) {
      currentFilter = ageRange;
      let visibleCount = 0;
      const normalizedFilter = ageRange ? ageRange.toLowerCase().trim() : 'all';

      {%- comment -%} Update button active states {%- endcomment -%}
      filterButtons.forEach(function(btn) {
        const btnFilter = btn.getAttribute('data-filter') ? btn.getAttribute('data-filter').toLowerCase().trim() : 'all';
        if (btnFilter === normalizedFilter) {
          btn.classList.add('is-active');
          btn.setAttribute('aria-selected', 'true');
        } else {
          btn.classList.remove('is-active');
          btn.setAttribute('aria-selected', 'false');
        }
      });

      {%- comment -%} Filter cards by age range {%- endcomment -%}
      cards.forEach(function(card) {
        const cardAgeRange = (card.getAttribute('data-age-range') || 'all').toLowerCase().trim();
        let shouldShow = false;

        if (normalizedFilter === 'all') {
          shouldShow = true;
        } else {
          {%- comment -%} Show if age range matches OR if card has age_range="all" (always visible) {%- endcomment -%}
          if (normalizedFilter === cardAgeRange || cardAgeRange === 'all') {
            shouldShow = true;
          } else {
            shouldShow = false;
          }
        }

        if (shouldShow) {
          card.classList.remove('best-sellers-on-sale__card--filtered-out');
          visibleCount++;
        } else {
          card.classList.add('best-sellers-on-sale__card--filtered-out');
        }
      });

      {%- comment -%} Show/hide empty state {%- endcomment -%}
      if (emptyState) {
        if (visibleCount === 0) {
          emptyState.style.display = 'block';
          if (grid) grid.style.display = 'none';
        } else {
          emptyState.style.display = 'none';
          if (grid) grid.style.display = 'grid';
        }
      }
    }

    {%- comment -%} Reset filter function - shows all products {%- endcomment -%}
    function resetFilter() {
      currentFilter = null;
      filterButtons.forEach(function(btn) {
        btn.classList.remove('is-active');
        btn.setAttribute('aria-selected', 'false');
      });
      filterByAge('all');
    }

    {%- comment -%} Add click handlers - matches SCG pattern: clicking same button resets to ALL {%- endcomment -%}
    filterButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const filterType = this.getAttribute('data-filter');
        const normalizedFilter = filterType ? filterType.toLowerCase().trim() : 'all';
        
        {%- comment -%} If clicking the same active filter, reset to ALL {%- endcomment -%}
        if (currentFilter && currentFilter.toLowerCase().trim() === normalizedFilter) {
          resetFilter();
        } else {
          filterByAge(filterType);
        }
      });
    });

    {%- comment -%} Initialize: show all products {%- endcomment -%}
    filterByAge('all');

    // ===== AJAX ADD TO CART =====
    async function addToCart(variantId, qty) {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ id: Number(variantId), quantity: qty || 1 })
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error('Add to cart failed: ' + txt);
      }
      return res.json();
    }

    async function fetchCart() {
      const res = await fetch('/cart.js', { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('Cart fetch failed');
      return res.json();
    }

    function updateHeaderCartCount(count) {
      // Try common selectors (your hero header uses .hero-slideshow__cart-badge / mobile-cart-badge)
      const sectionIdStr = sectionId;
      const badges = document.querySelectorAll(
        '.hero-slideshow-' + sectionIdStr + '__cart-badge, .hero-slideshow-' + sectionIdStr + '__mobile-cart-badge, .cart-count-bubble span, [data-cart-count]'
      );
      badges.forEach((b) => {
        if (b) b.textContent = String(count);
      });
    }

    const atcButtons = section.querySelectorAll('.best-sellers-on-sale__atc[data-variant-id]');
    atcButtons.forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const variantId = btn.getAttribute('data-variant-id');
        if (!variantId || btn.disabled) return;

        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        try {
          await addToCart(variantId, 1);
          const cart = await fetchCart();
          updateHeaderCartCount(cart.item_count);

          btn.textContent = 'Added';
          setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
          }, 900);
        } catch (err) {
          console.error(err);
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
          }, 1200);
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Best Sellers on Sale",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Best Sellers on Sale"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "SHOP NOW"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button Link"
    },
    {
      "type": "header",
      "content": "Top CTA Buttons"
    },
    {
      "type": "text",
      "id": "top_cta_1_label",
      "label": "Top CTA 1 Label",
      "default": "SHOP BEST SELLERS",
      "info": "Filter tab for products with badge tag"
    },
    {
      "type": "text",
      "id": "top_cta_2_label",
      "label": "Top CTA 2 Label",
      "default": "SHOP ALL AW25",
      "info": "Filter tab for products on sale"
    },
    {
      "type": "color",
      "id": "top_cta_bg",
      "label": "Top CTA Background",
      "default": "#b7aca4"
    },
    {
      "type": "color",
      "id": "top_cta_text",
      "label": "Top CTA Text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Badge Settings"
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Badge Text",
      "default": "Best Seller"
    },
    {
      "type": "text",
      "id": "badge_tag",
      "label": "Badge Tag",
      "default": "Best Seller",
      "info": "Show badge only if product has this tag (case-insensitive). Leave blank to always show badge."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "section_bg",
      "label": "Section Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_bg",
      "label": "Card Background",
      "default": "#f3f3f3"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button Background",
      "default": "#b7aca4"
    },
    {
      "type": "color",
      "id": "button_text",
      "label": "Button Text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "badge_bg",
      "label": "Badge Background",
      "default": "#d8d0c8"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Badge Text Color",
      "default": "#4b4b4b"
    },
    {
      "type": "header",
      "content": "Card Dimensions"
    },
    {
      "type": "range",
      "id": "card_height_desktop",
      "label": "Card Height (Desktop)",
      "min": 400,
      "max": 700,
      "step": 20,
      "unit": "px",
      "default": 520
    },
    {
      "type": "range",
      "id": "card_height_tablet",
      "label": "Card Height (Tablet)",
      "min": 350,
      "max": 600,
      "step": 10,
      "unit": "px",
      "default": 460
    },
    {
      "type": "range",
      "id": "card_height_mobile",
      "label": "Card Height (Mobile)",
      "min": 300,
      "max": 500,
      "step": 20,
      "unit": "px",
      "default": 440
    },
    {
      "type": "range",
      "id": "image_max_width",
      "label": "Image Max Width",
      "min": 400,
      "max": 1200,
      "step": 50,
      "unit": "px",
      "default": 900,
      "info": "Maximum image width for performance optimization"
    }
  ],
  "blocks": [
    {
      "type": "product_card",
      "name": "Product Card",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image",
          "info": "Optional: Override product featured image"
        },
        {
          "type": "text",
          "id": "age_range",
          "label": "Age Range",
          "default": "all",
          "info": "Enter the age range value (e.g., '0.5-4', '5-7', 'all'). This must match the age range set on filter buttons."
        }
      ]
    }
  ],
  "max_blocks": 5,
  "presets": [
    {
      "name": "Best Sellers on Sale"
    }
  ]
}
{% endschema %}
