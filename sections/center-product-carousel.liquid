{%- liquid
  assign section_id = section.id
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign alignment = section.settings.alignment
  assign heading_size = section.settings.heading_size | default: 24
  assign heading_color = section.settings.heading_color
  assign card_radius = section.settings.card_radius | default: 18
  assign card_bottom_radius = section.settings.card_bottom_radius | default: 18
  assign card_width = section.settings.card_width
  assign gap = section.settings.gap | default: 20
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign autoplay = section.settings.autoplay
  assign autoplay_seconds = section.settings.autoplay_seconds | default: 5
  assign show_vendor = section.settings.show_vendor
  assign show_color_swatches = section.settings.show_color_swatches
  assign card_content_bg_color = section.settings.card_content_bg_color
  assign card_content_text_color = section.settings.card_content_text_color
  assign card_content_border_color = section.settings.card_content_border_color
  assign card_content_border_width = section.settings.card_content_border_width | default: 0
  assign card_content_border_radius = section.settings.card_content_border_radius | default: 0
  assign card_content_padding = section.settings.card_content_padding | default: 24
  assign card_content_margin = section.settings.card_content_margin | default: 0
  assign item_blocks = section.blocks | where: 'type', 'product'
-%}

<section
  id="CenterProductCarousel-{{ section_id }}"
  class="cpc-section cpc-section--{{ section_id }}"
  data-section-id="{{ section_id }}"
  data-autoplay="{{ autoplay }}"
  data-autoplay-delay="{{ autoplay_seconds }}"
  data-loop="true"
  style="--cpc-gap: {{ gap }}px; --cpc-card-radius: {{ card_radius }}px; --cpc-card-bottom-radius: {{ card_bottom_radius }}px;{% if card_width != blank %} --cpc-card-width: {{ card_width }}px;{% endif %} --cpc-autoplay-delay: {{ autoplay_seconds }}s; --cpc-heading-size: {{ heading_size }}px;{% if heading_color != blank %} --cpc-heading-color: {{ heading_color }};{% endif %}{% if card_content_bg_color != blank %} --cpc-card-content-bg: {{ card_content_bg_color }};{% endif %}{% if card_content_text_color != blank %} --cpc-card-content-text: {{ card_content_text_color }};{% endif %}{% if card_content_border_color != blank %} --cpc-card-content-border-color: {{ card_content_border_color }};{% endif %} --cpc-card-content-border-width: {{ card_content_border_width }}px; --cpc-card-content-border-radius: {{ card_content_border_radius }}px; --cpc-card-content-padding: {{ card_content_padding }}px; --cpc-card-content-margin: {{ card_content_margin }}px;"
>
  <div class="cpc-container">
    {%- if heading != blank or subheading != blank -%}
      <div class="cpc-header cpc-header--{{ alignment }}">
        {%- if heading != blank -%}
          <h2 class="cpc-heading">{{ heading }}</h2>
        {%- endif -%}
        {%- if subheading != blank -%}
          <p class="cpc-subheading">{{ subheading }}</p>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if item_blocks.size > 0 -%}
      <div class="cpc-carousel-wrapper">
        <div class="cpc-viewport" data-viewport>
          <div class="cpc-track" data-track>
            {%- for block in item_blocks -%}
              {%- assign product = block.settings.product -%}
              {%- if product != blank -%}
                <div class="cpc-slide{% if forloop.first %} is-active{% endif %}" {{ block.shopify_attributes }} data-slide-index="{{ forloop.index0 }}">
                <a href="{{ product.url }}" class="cpc-card" draggable="false">
                  <div class="cpc-media-tile">
                    {%- liquid
                      assign media_source = block.settings.media_source | default: 'product_featured'
                      assign focal_position = block.settings.focal_position | default: 'center'
                      assign object_position = 'center'
                      if focal_position == 'top'
                        assign object_position = 'top center'
                      elsif focal_position == 'bottom'
                        assign object_position = 'bottom center'
                      endif
                    -%}

                    {%- if block.settings.badge_text != blank -%}
                      <div class="cpc-badge">{{ block.settings.badge_text }}</div>
                    {%- endif -%}

                    {%- if media_source == 'external_gif_url' and block.settings.external_gif_url != blank -%}
                      {%- if forloop.first -%}
                        <img
                          draggable="false"
                          data-gif-url="{{ block.settings.external_gif_url }}"
                          src="{{ block.settings.external_gif_url }}"
                          alt="{{ block.settings.alt_text | default: product.title | escape }}"
                          class="cpc-card-image cpc-gif-image"
                          style="object-position: {{ object_position }};"
                        >
                      {%- else -%}
                        <img
                          draggable="false"
                          data-gif-url="{{ block.settings.external_gif_url }}"
                          src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                          alt="{{ block.settings.alt_text | default: product.title | escape }}"
                          class="cpc-card-image cpc-gif-image"
                          style="object-position: {{ object_position }};"
                          loading="lazy"
                        >
                      {%- endif -%}
                    {%- elsif media_source == 'custom_image_or_gif' and block.settings.custom_media != blank -%}
                      {%- liquid
                        assign media_url = block.settings.custom_media | image_url: width: 1200
                        assign is_gif = false
                        if block.settings.custom_media.alt contains '.gif' or media_url contains '.gif'
                          assign is_gif = true
                        endif
                      -%}
                      {%- if is_gif -%}
                        {%- if forloop.first -%}
                          <img
                            draggable="false"
                            data-gif-url="{{ media_url }}"
                            src="{{ media_url }}"
                            alt="{{ block.settings.alt_text | default: product.title | escape }}"
                            class="cpc-card-image cpc-gif-image"
                            style="object-position: {{ object_position }};"
                          >
                        {%- else -%}
                          <img
                            draggable="false"
                            data-gif-url="{{ media_url }}"
                            src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                            alt="{{ block.settings.alt_text | default: product.title | escape }}"
                            class="cpc-card-image cpc-gif-image"
                            style="object-position: {{ object_position }};"
                            loading="lazy"
                          >
                        {%- endif -%}
                      {%- else -%}
                        <img
                          draggable="false"
                          src="{{ media_url }}"
                          alt="{{ block.settings.alt_text | default: product.title | escape }}"
                          class="cpc-card-image"
                          style="object-position: {{ object_position }};"
                          {% unless forloop.first %}loading="lazy"{% endunless %}
                        >
                      {%- endif -%}
                    {%- elsif product.featured_media != blank -%}
                      <img
                        draggable="false"
                        src="{{ product.featured_media | image_url: width: 1200 }}"
                        srcset="{{ product.featured_media | image_url: width: 300 }} 300w,
                                {{ product.featured_media | image_url: width: 600 }} 600w,
                                {{ product.featured_media | image_url: width: 900 }} 900w,
                                {{ product.featured_media | image_url: width: 1200 }} 1200w"
                        sizes="(max-width: 749px) 85vw, 400px"
                        alt="{{ block.settings.alt_text | default: product.featured_media.alt | default: product.title | escape }}"
                        class="cpc-card-image"
                        style="object-position: {{ object_position }};"
                        {% unless forloop.first %}loading="lazy"{% endunless %}
                        width="{{ product.featured_media.width }}"
                        height="{{ product.featured_media.height }}"
                      >
                    {%- else -%}
                      <div class="cpc-card-placeholder">
                        {{ 'product-1' | placeholder_svg_tag: 'cpc-placeholder-svg' }}
                      </div>
                    {%- endif -%}
                  </div>

                  <div class="cpc-info-card">
                    <div class="cpc-info-thumb">
                      {%- if product.featured_media != blank -%}
                        <img
                          draggable="false"
                          src="{{ product.featured_media | image_url: width: 120 }}"
                          alt="{{ product.featured_media.alt | default: product.title | escape }}"
                          class="cpc-info-thumb-image"
                          {% unless forloop.first %}loading="lazy"{% endunless %}
                          width="120"
                          height="120"
                        >
                      {%- else -%}
                        <div class="cpc-info-thumb-placeholder">
                          {{ 'product-1' | placeholder_svg_tag: 'cpc-info-thumb-placeholder-svg' }}
                        </div>
                      {%- endif -%}
                    </div>
                    
                    <div class="cpc-info-text">
                      <h3 class="cpc-info-title">{{ product.title }}</h3>
                      <div class="cpc-info-price">
                        {%- assign variant = product.selected_or_first_available_variant -%}
                        {%- if variant.compare_at_price > variant.price -%}
                          <span class="cpc-price-compare">{{ variant.compare_at_price | money }}</span>
                        {%- endif -%}
                        <span class="cpc-price-current">{{ variant.price | money }}</span>
                      </div>
                    </div>

                    <div class="cpc-info-caret">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                  </div>
                </a>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- else -%}
      <div class="cpc-empty">
        <p>{{ 'sections.collection_template.empty' | t | default: 'Add products to this carousel' }}</p>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  /* Center Product Carousel Styles */
  .cpc-section--{{ section_id }} {
    padding: 4rem 0;
    position: relative;
  }

  .cpc-section--{{ section_id }} .cpc-container {
    max-width: var(--page-width, 120rem);
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .cpc-section--{{ section_id }} .cpc-header {
    margin-bottom: 3rem;
    text-align: {{ alignment }};
  }

  .cpc-section--{{ section_id }} .cpc-heading {
    font-size: var(--cpc-heading-size, 2.4rem);
    font-weight: 600;
    margin: 0 0 1rem;
    line-height: 1.2;
    {%- if heading_color != blank -%}
      color: var(--cpc-heading-color);
    {%- endif -%}
  }

  .cpc-section--{{ section_id }} .cpc-subheading {
    font-size: 1.6rem;
    color: rgba(var(--color-foreground), 0.7);
    margin: 0;
    line-height: 1.5;
  }

  .cpc-section--{{ section_id }} .cpc-carousel-wrapper {
    position: relative;
    padding: 0 4rem;
  }

  @media screen and (max-width: 749px) {
    .cpc-section--{{ section_id }} .cpc-carousel-wrapper {
      padding: 0 3rem;
    }
  }

  .cpc-section--{{ section_id }} .cpc-viewport {
    overflow: hidden;
  }

  .cpc-section--{{ section_id }} .cpc-track {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    gap: var(--cpc-gap);
    padding: 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-snap-type: x mandatory;
  }

  .cpc-section--{{ section_id }} .cpc-track::-webkit-scrollbar {
    display: none;
  }

  .cpc-section--{{ section_id }} .cpc-slide {
    min-width: 0;
    flex: 0 0 100%;
    scroll-snap-align: center;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    transform-origin: center;
    opacity: 0.88;
    transform: scale(0.95);
  }

  @media screen and (min-width: 750px) {
    .cpc-section--{{ section_id }} .cpc-slide {
      flex: 0 0 calc((100% - var(--cpc-gap)) / 2);
    }
  }

  @media screen and (min-width: 990px) {
    .cpc-section--{{ section_id }} .cpc-slide {
      flex: 0 0 calc((100% - (var(--cpc-gap) * 2)) / 3);
    }
  }

  .cpc-section--{{ section_id }} .cpc-slide.is-active {
    opacity: 1;
    transform: scale(1);
    z-index: 2;
  }

  .cpc-section--{{ section_id }} .cpc-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    color: inherit;
    background: transparent;
    transition: transform 0.3s ease;
    max-width: var(--cpc-card-width, 100%);
    width: 100%;
  }

  .cpc-section--{{ section_id }} .cpc-media-tile {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    background: rgba(var(--color-foreground), 0.03);
    border-radius: var(--cpc-card-radius);
    box-shadow: 0 4px 16px rgba(var(--color-foreground), 0.08);
    transition: box-shadow 0.3s ease;
  }

  .cpc-section--{{ section_id }} .cpc-slide.is-active .cpc-media-tile {
    box-shadow: 0 8px 24px rgba(var(--color-foreground), 0.12);
  }

  .cpc-section--{{ section_id }} .cpc-badge {
    position: absolute;
    top: 1.2rem;
    left: 1.2rem;
    background: rgba(var(--color-button), 1);
    color: rgba(var(--color-button-text), 1);
    padding: 0.6rem 1.2rem;
    border-radius: 2rem;
    font-size: 1.2rem;
    font-weight: 600;
    z-index: 2;
  }

  .cpc-section--{{ section_id }} .cpc-card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    transition: transform 0.5s ease;
  }

  .cpc-section--{{ section_id }} .cpc-slide.is-active .cpc-card-image {
    transform: scale(1.02);
  }

  .cpc-section--{{ section_id }} .cpc-card-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-foreground), 0.03);
  }

  .cpc-section--{{ section_id }} .cpc-info-card {
    display: flex;
    align-items: center;
    gap: 1.2rem;
    width: calc(100% - 2.4rem);
    margin-left: 1.2rem;
    margin-right: 1.2rem;
    margin-top: -1.8rem;
    padding: var(--cpc-card-content-padding, 1.2rem);
    background: var(--cpc-card-content-bg, rgba(var(--color-background), 1));
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 1));
    {%- if card_content_border_width > 0 -%}
      border: var(--cpc-card-content-border-width) solid var(--cpc-card-content-border-color, rgba(var(--color-foreground), 0.12));
    {%- else -%}
      border: 1px solid var(--cpc-card-content-border-color, rgba(var(--color-foreground), 0.12));
    {%- endif -%}
    {%- if card_content_border_radius > 0 -%}
      border-radius: var(--cpc-card-content-border-radius);
    {%- else -%}
      border-radius: 1.4rem;
    {%- endif -%}
    box-shadow: 0 2px 12px rgba(var(--color-foreground), 0.06);
    position: relative;
    z-index: 1;
  }

  .cpc-section--{{ section_id }} .cpc-info-thumb {
    flex-shrink: 0;
    width: 5.6rem;
    height: 5.6rem;
    border-radius: 0.8rem;
    overflow: hidden;
    background: rgba(var(--color-foreground), 0.03);
  }

  @media screen and (max-width: 749px) {
    .cpc-section--{{ section_id }} .cpc-info-thumb {
      width: 4.4rem;
      height: 4.4rem;
    }
  }

  .cpc-section--{{ section_id }} .cpc-info-thumb-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .cpc-section--{{ section_id }} .cpc-info-thumb-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cpc-section--{{ section_id }} .cpc-info-thumb-placeholder svg {
    width: 100%;
    height: 100%;
    opacity: 0.3;
  }

  .cpc-section--{{ section_id }} .cpc-info-text {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .cpc-section--{{ section_id }} .cpc-info-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.3;
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 1));
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media screen and (max-width: 749px) {
    .cpc-section--{{ section_id }} .cpc-info-title {
      font-size: 1.4rem;
    }
  }

  .cpc-section--{{ section_id }} .cpc-info-price {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 1));
  }

  @media screen and (max-width: 749px) {
    .cpc-section--{{ section_id }} .cpc-info-price {
      font-size: 1.3rem;
    }
  }

  .cpc-section--{{ section_id }} .cpc-price-compare {
    text-decoration: line-through;
    opacity: 0.6;
    font-size: 1.2rem;
    font-weight: 400;
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 0.6));
  }

  @media screen and (max-width: 749px) {
    .cpc-section--{{ section_id }} .cpc-price-compare {
      font-size: 1.1rem;
    }
  }

  .cpc-section--{{ section_id }} .cpc-price-current {
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 1));
  }

  .cpc-section--{{ section_id }} .cpc-info-caret {
    flex-shrink: 0;
    width: 1.6rem;
    height: 1.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--cpc-card-content-text, rgba(var(--color-foreground), 0.5));
  }

  .cpc-section--{{ section_id }} .cpc-info-caret svg {
    width: 100%;
    height: 100%;
  }

  .cpc-section--{{ section_id }} .cpc-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 4.4rem;
    height: 4.4rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(var(--color-foreground), 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 3;
    transition: transform 0.2s ease, background 0.2s ease, opacity 0.2s ease;
    color: rgba(var(--color-foreground), 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .cpc-section--{{ section_id }} .cpc-arrow:hover:not(:disabled) {
    transform: translateY(-50%) scale(1.1);
    background: rgba(255, 255, 255, 1);
  }

  .cpc-section--{{ section_id }} .cpc-arrow:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .cpc-section--{{ section_id }} .cpc-arrow--prev {
    left: 0;
  }

  .cpc-section--{{ section_id }} .cpc-arrow--next {
    right: 0;
  }

  .cpc-section--{{ section_id }} .cpc-dots {
    display: flex;
    justify-content: center;
    gap: 0.8rem;
    margin-top: 2rem;
  }

  .cpc-section--{{ section_id }} .cpc-dot {
    width: 0.8rem;
    height: 0.8rem;
    border-radius: 50%;
    border: none;
    background: rgba(var(--color-foreground), 0.3);
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
    padding: 0;
  }

  .cpc-section--{{ section_id }} .cpc-dot:hover {
    transform: scale(1.2);
  }

  .cpc-section--{{ section_id }} .cpc-dot--active {
    background: rgba(var(--color-foreground), 1);
    transform: scale(1.3);
  }

  .cpc-section--{{ section_id }} .cpc-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: rgba(var(--color-foreground), 0.6);
  }

  .cpc-section--{{ section_id }} .cpc-card-image {
    -webkit-user-drag: none;
    user-drag: none;
  }

  .cpc-section--{{ section_id }} .cpc-card,
  .cpc-section--{{ section_id }} .cpc-card * {
    -webkit-user-drag: none;
    user-drag: none;
  }

  .cpc-section--{{ section_id }} .cpc-track {
    cursor: grab;
    touch-action: pan-y;
  }

  .cpc-section--{{ section_id }} .cpc-track:active {
    cursor: grabbing;
  }
</style>

<script>
  // Immediately stop any GIFs on page load (except in active slide)
  (function() {
    const placeholderGif = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
    const sectionId = '{{ section_id }}';
    const section = document.querySelector(`#CenterProductCarousel-${sectionId}`);
    if (section) {
      const allSlides = section.querySelectorAll('.cpc-slide');
      allSlides.forEach((slide) => {
        // Only stop GIFs in non-active slides
        if (!slide.classList.contains('is-active')) {
          const gifImages = slide.querySelectorAll('.cpc-gif-image[data-gif-url]');
          gifImages.forEach((img) => {
            if (img.dataset.gifUrl && !img.src.includes(img.dataset.gifUrl.split('?')[0].split('#')[0])) {
              img.src = placeholderGif;
            }
          });
        }
      });
    }
  })();
</script>

<script>
  (function () {
    'use strict';

    const sectionId = '{{ section_id }}';
    const section = document.querySelector(`#CenterProductCarousel-${sectionId}`);
    if (!section) return;

    const viewport = section.querySelector('[data-viewport]');
    const track = section.querySelector('[data-track]');
    const prevBtn = section.querySelector('.cpc-arrow--prev');
    const nextBtn = section.querySelector('.cpc-arrow--next');
    const dots = Array.from(section.querySelectorAll('[data-dot-index]'));

    const autoplayEnabled = section.dataset.autoplay === 'true';
    const autoplayDelay = (parseInt(section.dataset.autoplayDelay, 10) || 5) * 1000;

    if (!track || !viewport) return;

    let originalSlides = [];
    let slides = [];
    let originalCount = 0;
    let clonesCount = 0;
    let currentIndex = 0;
    let currentRealIndex = 0;
    let autoplayTimer = null;
    let isPaused = false;
    let scrollRaf = null;
    let isScrolling = false;
    let isCorrecting = false;
    let isProgrammaticScroll = false;

    function getSlidesPerView() {
      if (window.matchMedia('(min-width: 990px)').matches) return 3;
      if (window.matchMedia('(min-width: 750px)').matches) return 2;
      return 1;
    }

    function getClosestIndexToCenter() {
      const trackRect = track.getBoundingClientRect();
      const trackCenter = trackRect.left + trackRect.width / 2;

      let closestIndex = 0;
      let closestDistance = Infinity;

      slides.forEach((slide, index) => {
        const r = slide.getBoundingClientRect();
        const c = r.left + r.width / 2;
        const d = Math.abs(trackCenter - c);
        if (d < closestDistance) {
          closestDistance = d;
          closestIndex = index;
        }
      });

      return closestIndex;
    }

    function getOriginalIndexByReal(realIndex) {
      const s = slides[realIndex];
      const v = s ? parseInt(s.dataset.originalIndex || '0', 10) : 0;
      return Number.isNaN(v) ? 0 : v;
    }

    function getRealIndex(originalIndex) {
      return clonesCount + originalIndex;
    }

    function stopAllGifs() {
      const placeholderGif = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
      const allSlides = track ? track.querySelectorAll('.cpc-slide') : document.querySelectorAll('.cpc-slide');
      allSlides.forEach((slide) => {
        // Don't stop GIFs in active slides
        if (slide.classList.contains('is-active')) return;
        
        const gifImages = slide.querySelectorAll('.cpc-gif-image[data-gif-url]');
        gifImages.forEach((img) => {
          if (img.dataset.gifUrl) {
            // Only stop if it's not already the placeholder
            if (!img.src.includes('data:image/gif;base64')) {
              img.src = placeholderGif;
              img.removeAttribute('srcset');
            }
          }
        });
      });
    }

    function setActiveByRealIndex(realIndex) {
      const placeholderGif = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
      
      slides.forEach((slide, i) => {
        const isActive = i === realIndex;
        slide.classList.toggle('is-active', isActive);
        
        const gifImages = slide.querySelectorAll('.cpc-gif-image[data-gif-url]');
        gifImages.forEach((img) => {
          const gifUrl = img.dataset.gifUrl;
          if (gifUrl) {
            if (isActive) {
              // Play GIF when active
              // Check if it's already the correct GIF URL (without timestamp)
              const baseGifUrl = gifUrl.split('?')[0].split('#')[0];
              if (!img.src.includes(baseGifUrl)) {
                // Add timestamp to force reload/restart if needed
                const separator = gifUrl.includes('?') ? '&' : '?';
                img.src = gifUrl + separator + '_t=' + Date.now();
              } else if (img.src === placeholderGif || img.src.includes('data:image/gif;base64')) {
                // If it's currently the placeholder, load the GIF
                img.src = gifUrl;
              }
            } else {
              // Stop GIF when inactive
              if (img.src !== placeholderGif && !img.src.includes('data:image/gif;base64')) {
                img.src = placeholderGif;
                img.removeAttribute('srcset');
              }
            }
          }
        });
      });
    }

    function updateDots() {
      // Dots removed - no-op
    }

    let scrollEndTimer = null;

    function onScroll() {
      // Don't correct during programmatic scrolling
      if (isScrolling || isProgrammaticScroll) return;
      
      if (scrollEndTimer) clearTimeout(scrollEndTimer);
      scrollEndTimer = setTimeout(() => {
        // Only correct if user-initiated scroll has stopped
        if (!isScrolling && !isProgrammaticScroll) {
          correctPosition();
        }
      }, 150);
    }

    function correctPosition() {
      if (isCorrecting || slides.length === 0 || isScrolling) return;
      
      const closestReal = getClosestIndexToCenter();
      let corrected = closestReal;
      let needsJump = false;
      
      // With 3 copies per side, we have: [PRE x3] + [MIDDLE] + [POST x3]
      // Middle starts at clonesCount, ends at clonesCount + originalCount
      if (closestReal < clonesCount) {
        // In prepended copies - jump to corresponding position in middle copy
        const offsetInPre = closestReal % originalCount;
        corrected = clonesCount + offsetInPre;
        needsJump = true;
      } else if (closestReal >= clonesCount + originalCount) {
        // In appended copies - jump to corresponding position in middle copy
        const offsetInPost = (closestReal - clonesCount - originalCount) % originalCount;
        corrected = clonesCount + offsetInPost;
        needsJump = true;
      }
      
      // Only jump if we're actually in a clone region
      if (needsJump) {
        isCorrecting = true;
        const target = slides[corrected];
        if (target) {
          // Use requestAnimationFrame to ensure smooth jump
          requestAnimationFrame(() => {
            track.scrollTo({
              left: target.offsetLeft - (track.offsetWidth / 2) + (target.offsetWidth / 2),
              behavior: 'auto'
            });
            // Update indices after jump
            currentRealIndex = corrected;
            currentIndex = getOriginalIndexByReal(corrected);
            setActiveByRealIndex(corrected);
            updateDots();
            setTimeout(() => { isCorrecting = false; }, 50);
          });
        } else {
          isCorrecting = false;
        }
      } else {
        // We're in the middle copy - just update indices without jumping
        currentRealIndex = corrected;
        currentIndex = getOriginalIndexByReal(corrected);
        setActiveByRealIndex(corrected);
        updateDots();
      }
    }

    function scrollToRealIndex(realIndex, smooth = true) {
      if (slides.length === 0) return;
      
      // Clamp to valid range
      realIndex = Math.max(0, Math.min(slides.length - 1, realIndex));
      const target = slides[realIndex];
      
      if (!target) return;

      isScrolling = true;
      isProgrammaticScroll = true;
      currentRealIndex = realIndex;
      currentIndex = getOriginalIndexByReal(realIndex);
      
      track.scrollTo({
        left: target.offsetLeft - (track.offsetWidth / 2) + (target.offsetWidth / 2),
        behavior: smooth ? 'smooth' : 'auto'
      });

      setActiveByRealIndex(realIndex);
      updateDots();

      setTimeout(() => {
        isScrolling = false;
        // Keep programmatic flag a bit longer to prevent correction
        setTimeout(() => {
          isProgrammaticScroll = false;
        }, smooth ? 200 : 100);
      }, smooth ? 600 : 150);

      if (autoplayEnabled && !isPaused) resetAutoplay();
    }

    function scrollToOriginalIndex(originalIndex, smooth = true) {
      if (originalCount === 0) return;
      
      originalIndex = ((originalIndex % originalCount) + originalCount) % originalCount;
      const realIndex = getRealIndex(originalIndex);
      scrollToRealIndex(realIndex, smooth);
    }

    function scrollToPrev() {
      if (slides.length <= 1) return;
      // Allow going into prepended copy naturally - correction only happens on user scroll
      const newRealIndex = Math.max(0, currentRealIndex - 1);
      scrollToRealIndex(newRealIndex, true);
    }

    function scrollToNext() {
      if (slides.length <= 1) return;
      // Allow going into appended copy naturally - correction only happens on user scroll
      const newRealIndex = Math.min(slides.length - 1, currentRealIndex + 1);
      scrollToRealIndex(newRealIndex, true);
    }

    function startAutoplay() {
      if (!autoplayEnabled || isPaused || originalCount <= 1) return;
      autoplayTimer = window.setInterval(() => {
        scrollToNext();
      }, autoplayDelay);
    }

    function pauseAutoplay() {
      isPaused = true;
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    function resumeAutoplay() {
      isPaused = false;
      startAutoplay();
    }

    function resetAutoplay() {
      pauseAutoplay();
      resumeAutoplay();
    }

    // Swipe detection
    const DRAG_START_PX = 8;
    const CHANGE_SLIDE_THRESHOLD_PERCENT = 0.15;
    
    let isDragging = false;
    let startX = 0;
    let dragOffset = 0;
    let didDrag = false;
    let shouldPreventClick = false;

    function handlePointerDown(e) {
      if (originalCount <= 1) return;
      if (e.pointerType === 'mouse' && e.button !== 0) return;
      
      isDragging = true;
      didDrag = false;
      shouldPreventClick = false;
      startX = e.touches ? e.touches[0].clientX : e.clientX;
      dragOffset = 0;
      track.style.cursor = 'grabbing';
      track.style.userSelect = 'none';
      
      // Try to capture pointer for better tracking
      try {
        if (e.pointerId !== undefined) {
          track.setPointerCapture(e.pointerId);
        }
      } catch (err) {
        // Ignore if pointer capture fails
      }
    }

    function handlePointerMove(e) {
      if (!isDragging) return;
      
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      dragOffset = x - startX;
      
      if (Math.abs(dragOffset) > DRAG_START_PX) {
        didDrag = true;
        shouldPreventClick = true;
        e.preventDefault();
      }
    }

    function handlePointerUp(e) {
      if (!isDragging) {
        dragOffset = 0;
        return;
      }
      
      // Release pointer capture
      try {
        if (e.pointerId !== undefined) {
          track.releasePointerCapture(e.pointerId);
        }
      } catch (err) {
        // Ignore if release fails
      }
      
      const slideWidth = slides[0] ? slides[0].offsetWidth : 0;
      const threshold = slideWidth ? slideWidth * CHANGE_SLIDE_THRESHOLD_PERCENT : 50;
      const wasDrag = Math.abs(dragOffset) > threshold;
      
      isDragging = false;
      track.style.cursor = 'grab';
      track.style.userSelect = '';
      
      if (wasDrag && didDrag) {
        e.preventDefault();
        e.stopPropagation();
        if (dragOffset > 0) {
          scrollToPrev();
        } else {
          scrollToNext();
        }
      } else if (didDrag) {
        // Small drag that didn't change slide - snap to nearest and prevent click
        e.preventDefault();
        e.stopPropagation();
        const closestRealIndex = getClosestIndexToCenter();
        scrollToRealIndex(closestRealIndex, true);
      }
      
      // Reset flag after delay to allow click event to be prevented
      setTimeout(() => {
        shouldPreventClick = false;
      }, 150);
      
      dragOffset = 0;
      didDrag = false;
    }

    function buildInfiniteLoop() {
      // For 1 or fewer slides, no loop needed
      if (originalCount <= 1) {
        slides = Array.from(originalSlides);
        clonesCount = 0;
        currentRealIndex = 0;
        currentIndex = 0;
        setActiveByRealIndex(0);
        updateDots();
        return;
      }

      // Remove existing clones
      const existingClones = track.querySelectorAll('.cpc-slide[data-clone="1"]');
      existingClones.forEach(clone => clone.remove());

      // Create 3 full copies on each side for seamless infinite loop
      const copiesPerSide = 3;
      clonesCount = originalCount * copiesPerSide;

      // Prepend 3 FULL copies in original order
      for (let copy = 0; copy < copiesPerSide; copy++) {
        for (let i = 0; i < originalCount; i++) {
          const clone = originalSlides[i].cloneNode(true);
          clone.dataset.clone = '1';
          clone.dataset.originalIndex = i;
          track.insertBefore(clone, originalSlides[0]);
        }
      }

      // Append 3 FULL copies in original order
      for (let copy = 0; copy < copiesPerSide; copy++) {
        for (let i = 0; i < originalCount; i++) {
          const clone = originalSlides[i].cloneNode(true);
          clone.dataset.clone = '1';
          clone.dataset.originalIndex = i;
          track.appendChild(clone);
        }
      }

      // Rebuild slides array
      slides = Array.from(track.querySelectorAll('.cpc-slide'));
      
      // Stop all GIFs first
      stopAllGifs();
      
      // Start in the middle copy (first slide of middle copy)
      const middleStartIndex = clonesCount + currentIndex;
      const middleStartSlide = slides[middleStartIndex];
      if (middleStartSlide) {
        track.scrollTo({
          left: middleStartSlide.offsetLeft - (track.offsetWidth / 2) + (middleStartSlide.offsetWidth / 2),
          behavior: 'auto'
        });
      }
      
      currentRealIndex = middleStartIndex;
      setActiveByRealIndex(middleStartIndex);
      updateDots();
    }

    function init() {
      // Get original slides
      originalSlides = Array.from(track.querySelectorAll('.cpc-slide')).filter(slide => !slide.dataset.clone);
      originalCount = originalSlides.length;
      
      if (originalCount === 0) return;

      // Mark original slides with data-original-index
      originalSlides.forEach((slide, index) => {
        slide.dataset.originalIndex = index;
      });

      // Build infinite loop
      buildInfiniteLoop();

      track.addEventListener('scroll', () => {
        onScroll();
      }, { passive: true });

      track.addEventListener('pointerdown', handlePointerDown);
      track.addEventListener('pointermove', handlePointerMove);
      track.addEventListener('pointerup', handlePointerUp);
      track.addEventListener('pointercancel', handlePointerUp);

      // Prevent link clicks only if drag happened
      track.addEventListener('click', (e) => {
        if (shouldPreventClick && e.target.closest('a')) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      if (autoplayEnabled) {
        startAutoplay();
        section.addEventListener('mouseenter', pauseAutoplay);
        section.addEventListener('mouseleave', resumeAutoplay);
        section.addEventListener('focusin', pauseAutoplay);
        section.addEventListener('focusout', resumeAutoplay);
      }

      // Handle window resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          buildInfiniteLoop();
        }, 250);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    document.addEventListener('shopify:section:load', function (e) {
      const root = e.detail || e.target;
      const loaded = root.querySelector
        ? root.querySelector(`#CenterProductCarousel-${sectionId}`)
        : (root.id === `CenterProductCarousel-${sectionId}` ? root : null);

      if (loaded) setTimeout(init, 60);
    });

  })();
</script>

{% schema %}
{
  "name": "Center Product Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Heading alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading size",
      "min": 16,
      "max": 60,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "info": "Leave empty to use theme default text color"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between cards",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card border radius (top)",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 18,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_bottom_radius",
      "label": "Card border radius (bottom)",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 18,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card max width",
      "min": 200,
      "max": 800,
      "step": 20,
      "default": 400,
      "unit": "px",
      "info": "Maximum width for each card. Leave empty for full width."
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "label": "Show color swatches",
      "default": true
    },
    {
      "type": "color",
      "id": "card_content_bg_color",
      "label": "Card content background color",
      "info": "Background color for the product information area"
    },
    {
      "type": "color",
      "id": "card_content_text_color",
      "label": "Card content text color",
      "info": "Text color for product title, price, and vendor"
    },
    {
      "type": "header",
      "content": "Card Content Border"
    },
    {
      "type": "color",
      "id": "card_content_border_color",
      "label": "Border color"
    },
    {
      "type": "range",
      "id": "card_content_border_width",
      "label": "Border width",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_content_border_radius",
      "label": "Border radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_content_padding",
      "label": "Padding",
      "min": 0,
      "max": 60,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_content_margin",
      "label": "Margin",
      "min": 0,
      "max": 60,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show dots indicator",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_seconds",
      "label": "Autoplay delay",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "info": "Only applies if autoplay is enabled"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Badge text",
          "info": "Optional badge text to display on the media"
        },
        {
          "type": "select",
          "id": "media_source",
          "label": "Media source",
          "options": [
            {
              "value": "product_featured",
              "label": "Product featured image"
            },
            {
              "value": "custom_image_or_gif",
              "label": "Custom image/GIF"
            },
            {
              "value": "external_gif_url",
              "label": "External GIF URL"
            }
          ],
          "default": "product_featured"
        },
        {
          "type": "image_picker",
          "id": "custom_media",
          "label": "Custom image/GIF",
          "info": "Only used if media source is 'Custom image/GIF'"
        },
        {
          "type": "text",
          "id": "external_gif_url",
          "label": "External GIF URL",
          "info": "Only used if media source is 'External GIF URL'"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt text",
          "info": "Override default alt text for the image"
        },
        {
          "type": "select",
          "id": "focal_position",
          "label": "Focal point",
          "options": [
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "top",
              "label": "Top"
            },
            {
              "value": "bottom",
              "label": "Bottom"
            }
          ],
          "default": "center"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Center Product Carousel",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}

